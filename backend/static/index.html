<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
      
    <title>MotoFlash - Despacho Inteligente</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        body { font-family: 'Inter', system-ui, sans-serif; }
    </style>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useCallback } = React;
        
        // ============ CONFIGURA√á√ÉO ============
        const API_URL = window.location.origin;
        
        // ============ AUTENTICA√á√ÉO ============
        
        // Pega o token do localStorage
        const getToken = () => localStorage.getItem('motoflash_token');
        
        // Verifica se est√° logado
        const isLoggedIn = () => !!getToken();
        
        // Fetch autenticado - adiciona o token automaticamente
        const authFetch = async (url, options = {}) => {
            const token = getToken();
            
            if (!token) {
                // N√£o est√° logado, redireciona
                window.location.href = '/login';
                throw new Error('N√£o autenticado');
            }
            
            const headers = {
                ...options.headers,
                'Authorization': `Bearer ${token}`
            };
            
            // Se for JSON, adiciona content-type
            if (options.body && typeof options.body === 'string') {
                headers['Content-Type'] = 'application/json';
            }
            
            const response = await fetch(url, { ...options, headers });
            
            // Se receber 401, limpa token e redireciona
            if (response.status === 401) {
                localStorage.removeItem('motoflash_token');
                localStorage.removeItem('motoflash_user');
                window.location.href = '/login';
                throw new Error('Sess√£o expirada');
            }
            
            return response;
        };
        
        // Verifica login ao carregar
        if (!isLoggedIn()) {
            window.location.href = '/login';
        }
        
        // ============ COMPONENTE DE CRON√îMETRO ============
        
        const Timer = ({ startTime }) => {
          const [elapsed, setElapsed] = useState(0);
          
          useEffect(() => {
            if (!startTime) return;
            
            // FIX: Normaliza a data para UTC se n√£o tiver timezone
            let dateString = startTime;
            if (!dateString.endsWith('Z') && !dateString.includes('+')) {
              dateString = dateString + 'Z'; // Assume UTC se n√£o especificado
            }
            
            const start = new Date(dateString).getTime();
            
            const updateTimer = () => {
              const now = Date.now();
              const diff = Math.floor((now - start) / 1000);
              // Garante que n√£o seja negativo
              setElapsed(Math.max(0, diff));
            };
            
            updateTimer();
            const interval = setInterval(updateTimer, 1000);
            
            return () => clearInterval(interval);
          }, [startTime]);
          
          const minutes = Math.floor(elapsed / 60);
          const seconds = elapsed % 60;
          
          // Cores baseadas no tempo
          let bgColor = 'bg-green-100 text-green-700';
          if (minutes >= 15) bgColor = 'bg-yellow-100 text-yellow-700';
          if (minutes >= 25) bgColor = 'bg-orange-100 text-orange-700';
          if (minutes >= 35) bgColor = 'bg-red-100 text-red-700';
          
          return (
            <span className={`${bgColor} text-xs px-2 py-1 rounded font-mono font-bold`}>
              ‚è±Ô∏è {String(minutes).padStart(2, '0')}:{String(seconds).padStart(2, '0')}
            </span>
          );
        };
        
        // ============ COMPONENTES AUXILIARES ============
        
        const StatusBadge = ({ status }) => {
          const colors = {
            created: 'bg-gray-500',
            preparing: 'bg-yellow-500',
            ready: 'bg-green-500',
            assigned: 'bg-blue-500',
            picked_up: 'bg-purple-500',
            delivered: 'bg-emerald-600',
            available: 'bg-green-500',
            busy: 'bg-orange-500',
            offline: 'bg-gray-400',
          };
          
          const labels = {
            created: 'Criado',
            preparing: 'Preparando',
            ready: 'Pronto',
            assigned: 'Atribu√≠do',
            picked_up: 'Coletado',
            delivered: 'Entregue',
            available: 'Dispon√≠vel',
            busy: 'Em entrega',
            offline: 'Offline',
          };
          
          return (
            <span className={`${colors[status] || 'bg-gray-500'} text-white text-xs px-2 py-1 rounded-full font-medium`}>
              {labels[status] || status}
            </span>
          );
        };
        
        const Card = ({ children, className = '' }) => (
          <div className={`bg-white rounded-xl shadow-sm border border-gray-100 ${className}`}>
            {children}
          </div>
        );
        
        const Button = ({ children, onClick, variant = 'primary', disabled = false, className = '' }) => {
          const variants = {
            primary: 'bg-orange-500 hover:bg-orange-600 text-white',
            secondary: 'bg-gray-100 hover:bg-gray-200 text-gray-700',
            success: 'bg-green-500 hover:bg-green-600 text-white',
            danger: 'bg-red-500 hover:bg-red-600 text-white',
          };
          
          return (
            <button
              onClick={onClick}
              disabled={disabled}
              className={`px-4 py-2 rounded-lg font-medium transition-colors disabled:opacity-50 disabled:cursor-not-allowed ${variants[variant]} ${className}`}
            >
              {children}
            </button>
          );
        };
        
        // ============ PAINEL DE ESTAT√çSTICAS ============
        
        const StatsPanel = ({ stats }) => {
          if (!stats) return null;
          
          return (
            <div className="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6">
              <Card className="p-4 text-center">
                <div className="text-3xl font-bold text-orange-500">{stats.orders?.ready || 0}</div>
                <div className="text-sm text-gray-500">Pedidos Prontos</div>
              </Card>
              <Card className="p-4 text-center">
                <div className="text-3xl font-bold text-blue-500">{stats.orders?.assigned || 0}</div>
                <div className="text-sm text-gray-500">Em Rota</div>
              </Card>
              <Card className="p-4 text-center">
                <div className="text-3xl font-bold text-green-500">{stats.couriers?.available || 0}</div>
                <div className="text-sm text-gray-500">Motoboys Livres</div>
              </Card>
              <Card className="p-4 text-center">
                <div className="text-3xl font-bold text-purple-500">{stats.couriers?.busy || 0}</div>
                <div className="text-sm text-gray-500">Motoboys Ocupados</div>
              </Card>
              <Card className="p-4 text-center">
                <div className="text-3xl font-bold text-emerald-600">{stats.orders?.delivered || 0}</div>
                <div className="text-sm text-gray-500">Entregues Hoje</div>
              </Card>
            </div>
          );
        };
        
        // ============ PAINEL DE ALERTAS INTELIGENTES ============
        
        const AlertsPanel = ({ alerts, recommendation }) => {
          if (!alerts) return null;
          
          const statusColors = {
            critico: 'bg-red-100 border-red-300',
            atencao: 'bg-yellow-100 border-yellow-300',
            info: 'bg-blue-100 border-blue-300',
            sucesso: 'bg-green-100 border-green-300',
          };
          
          const statusTextColors = {
            critico: 'text-red-800',
            atencao: 'text-yellow-800',
            info: 'text-blue-800',
            sucesso: 'text-green-800',
          };
          
          const statusBgColors = {
            critico: 'bg-red-500',
            atencao: 'bg-yellow-500',
            info: 'bg-blue-500',
            sucesso: 'bg-green-500',
          };
          
          return (
            <Card className={`p-4 mb-6 border-2 ${statusColors[alerts.status_geral] || 'border-gray-200'}`}>
              <div className="flex items-center justify-between mb-3">
                <h3 className="font-semibold text-gray-700 flex items-center gap-2">
                  üß† Intelig√™ncia MotoFlash
                </h3>
                {recommendation && (
                  <div className="flex items-center gap-2 text-sm">
                    <span className="text-gray-500">Motoboys recomendados:</span>
                    <span className={`px-3 py-1 rounded-full font-bold text-white ${statusBgColors[alerts.status_geral]}`}>
                      {recommendation.motoboys_recomendados}
                    </span>
                  </div>
                )}
              </div>
              
              {/* Alertas */}
              <div className="space-y-2">
                {alerts.alertas?.map((alerta, idx) => (
                  <div 
                    key={idx} 
                    className={`p-3 rounded-lg border ${statusColors[alerta.tipo]} ${statusTextColors[alerta.tipo]}`}
                  >
                    <div className="flex items-start gap-2">
                      <span className="text-xl">{alerta.icone}</span>
                      <div className="flex-1">
                        <div className="font-semibold">{alerta.titulo}</div>
                        <div className="text-sm opacity-90">{alerta.mensagem}</div>
                        {alerta.acao_sugerida && (
                          <div className="text-sm mt-1 font-medium">
                            üí° {alerta.acao_sugerida}
                          </div>
                        )}
                      </div>
                    </div>
                  </div>
                ))}
              </div>
              
              {/* M√©tricas de contexto - sempre mostra */}
              {recommendation && (
                <div className="mt-4 pt-3 border-t border-gray-200 grid grid-cols-2 md:grid-cols-4 gap-3 text-sm">
                  <div className="text-center">
                    <div className="text-gray-500">Tempo preparo</div>
                    <div className="font-semibold text-gray-700">
                      {recommendation.tempo_medio_preparo ? `${recommendation.tempo_medio_preparo} min` : 'Coletando...'}
                    </div>
                  </div>
                  <div className="text-center">
                    <div className="text-gray-500">Tempo rota</div>
                    <div className="font-semibold text-gray-700">
                      {recommendation.tempo_medio_rota ? `${recommendation.tempo_medio_rota} min` : 'Coletando...'}
                    </div>
                  </div>
                  <div className="text-center">
                    <div className="text-gray-500">Pedidos/hora</div>
                    <div className="font-semibold text-gray-700">{recommendation.pedidos_por_hora || 0}</div>
                  </div>
                  <div className="text-center">
                    <div className="text-gray-500">Capacidade/motoboy</div>
                    <div className="font-semibold text-gray-700">
                      {recommendation.capacidade_por_motoboy ? `${recommendation.capacidade_por_motoboy}/h` : 'Coletando...'}
                    </div>
                  </div>
                </div>
              )}
            </Card>
          );
        };
        
        // ============ FORMUL√ÅRIO DE NOVO PEDIDO (MANUAL) ============
        
        const NewOrderForm = ({ onOrderCreated, simulatedDate }) => {
          const [loading, setLoading] = useState(false);
          const [status, setStatus] = useState('');
          const [errorMsg, setErrorMsg] = useState('');
          
          // Campos do formul√°rio
          const [phone, setPhone] = useState('');
          const [customerName, setCustomerName] = useState('');
          const [selectedItemId, setSelectedItemId] = useState('');
          
          // Campos de endere√ßo SEPARADOS
          const [cep, setCep] = useState('');           // CEP
          const [street, setStreet] = useState('');       // Rua
          const [number, setNumber] = useState('');       // N√∫mero
          const [neighborhood, setNeighborhood] = useState(''); // Bairro
          const [city, setCity] = useState('Ribeir√£o Preto');   // Cidade
          const [complement, setComplement] = useState(''); // Complemento
          const [loadingCep, setLoadingCep] = useState(false); // Loading do CEP
          
          // Cliente encontrado
          const [foundCustomer, setFoundCustomer] = useState(null);
          const [searchingCustomer, setSearchingCustomer] = useState(false);
          
          // Modo "outro endere√ßo" - quando cliente quer entregar em lugar diferente
          const [useOtherAddress, setUseOtherAddress] = useState(false);
          
          // Sugest√µes de clientes (autocomplete por nome)
          const [nameSuggestions, setNameSuggestions] = useState([]);
          const [showNameSuggestions, setShowNameSuggestions] = useState(false);
          
          // Autocomplete de endere√ßo (Photon)
          const [streetSuggestions, setStreetSuggestions] = useState([]);
          const [showStreetSuggestions, setShowStreetSuggestions] = useState(false);
          const [neighborhoodSuggestions, setNeighborhoodSuggestions] = useState([]);
          const [showNeighborhoodSuggestions, setShowNeighborhoodSuggestions] = useState(false);
          const [citySuggestions, setCitySuggestions] = useState([]);
          const [showCitySuggestions, setShowCitySuggestions] = useState(false);
          
          // Card√°pio
          const [menuData, setMenuData] = useState([]);
          const [loadingMenu, setLoadingMenu] = useState(true);
          
          // Formata telefone
          const formatPhone = (value) => {
            const numbers = value.replace(/\D/g, '');
            if (numbers.length <= 2) return `(${numbers}`;
            if (numbers.length <= 7) return `(${numbers.slice(0,2)}) ${numbers.slice(2)}`;
            return `(${numbers.slice(0,2)}) ${numbers.slice(2,7)}-${numbers.slice(7,11)}`;
          };
          
          // Formata CEP enquanto digita
          const formatCep = (value) => {
            const numbers = value.replace(/\D/g, '');
            if (numbers.length <= 5) return numbers;
            return `${numbers.slice(0,5)}-${numbers.slice(5,8)}`;
          };
          
          // Busca endere√ßo pelo CEP (ViaCEP)
          const handleCepChange = async (e) => {
            const formatted = formatCep(e.target.value);
            setCep(formatted);
            
            const numbers = formatted.replace(/\D/g, '');
            
            // Busca quando tiver 8 d√≠gitos
            if (numbers.length === 8) {
              setLoadingCep(true);
              try {
                const res = await fetch(`https://viacep.com.br/ws/${numbers}/json/`);
                if (res.ok) {
                  const data = await res.json();
                  if (!data.erro) {
                    setStreet(data.logradouro || '');
                    setNeighborhood(data.bairro || '');
                    setCity(data.localidade || '');
                    // Foca no campo n√∫mero ap√≥s preencher
                    setTimeout(() => {
                      document.getElementById('numberInput')?.focus();
                    }, 100);
                  }
                }
              } catch (err) {
                console.error('Erro ViaCEP:', err);
              }
              setLoadingCep(false);
            }
          };
          
          // Remove acentos para API Photon
          const removeAccents = (str) => str.normalize('NFD').replace(/[\u0300-\u036f]/g, '');
          
          // Busca sugest√µes no Photon
          const searchPhoton = async (query, type) => {
            if (query.trim().length < 3) return [];
            
            try {
              const cleanQuery = removeAccents(query);
              const fullQuery = type === 'city' 
                ? `${cleanQuery} Brasil`
                : `${cleanQuery} ${removeAccents(city || 'Ribeirao Preto')}`;
              
              const res = await fetch(
                `https://photon.komoot.io/api/?q=${encodeURIComponent(fullQuery)}&limit=5&lat=-21.17&lon=-47.80`
              );
              
              if (res.ok) {
                const data = await res.json();
                if (data.features && data.features.length > 0) {
                  // Extrai valores √∫nicos baseado no tipo
                  const values = new Set();
                  data.features.forEach(f => {
                    const p = f.properties;
                    if (type === 'street') {
                      const name = p.name || p.street;
                      if (name) values.add(name);
                    } else if (type === 'neighborhood') {
                      const bairro = p.suburb || p.district || p.locality || p.neighbourhood;
                      if (bairro && bairro !== p.city) values.add(bairro);
                    } else if (type === 'city') {
                      if (p.city) values.add(p.city);
                    }
                  });
                  return Array.from(values);
                }
              }
            } catch (err) {
              console.error('Erro Photon:', err);
            }
            return [];
          };
          
          // Busca cliente por telefone
          const handlePhoneChange = async (e) => {
            const formatted = formatPhone(e.target.value);
            setPhone(formatted);
            
            const numbers = formatted.replace(/\D/g, '');
            
            if (numbers.length >= 10) {
              setSearchingCustomer(true);
              try {
                const res = await authFetch(`${API_URL}/customers/phone/${numbers}`);
                if (res.ok) {
                  const customer = await res.json();
                  selectCustomer(customer);
                  setStatus('‚úÖ Cliente encontrado!');
                  setTimeout(() => setStatus(''), 2000);
                } else {
                  setFoundCustomer(null);
                  setUseOtherAddress(false);
                }
              } catch (err) {
                setFoundCustomer(null);
              }
              setSearchingCustomer(false);
            } else {
              setFoundCustomer(null);
              setUseOtherAddress(false);
            }
          };
          
          // Busca clientes por nome
          const handleNameChange = async (e) => {
            const value = e.target.value;
            setCustomerName(value);
            setFoundCustomer(null);
            
            if (value.trim().length >= 2) {
              try {
                const res = await authFetch(`${API_URL}/customers?search=${encodeURIComponent(value)}`);
                if (res.ok) {
                  const customers = await res.json();
                  setNameSuggestions(customers.slice(0, 5));
                  setShowNameSuggestions(customers.length > 0);
                }
              } catch (err) {
                setNameSuggestions([]);
              }
            } else {
              setNameSuggestions([]);
              setShowNameSuggestions(false);
            }
          };
          
          // Seleciona cliente
          const selectCustomer = (customer) => {
            setFoundCustomer(customer);
            setCustomerName(customer.name);
            setPhone(formatPhone(customer.phone));
            setComplement(customer.complement || '');
            setNameSuggestions([]);
            setShowNameSuggestions(false);
            setUseOtherAddress(false);
            
            // Parseia endere√ßo se existir
            if (customer.address) {
              parseAddress(customer.address);
            }
          };
          
          // Tenta parsear endere√ßo em campos separados
          // Formato esperado: "Rua X, 123 - Bairro, Cidade"
          const parseAddress = (fullAddress) => {
            // Primeiro separa por " - " para pegar o bairro
            const dashParts = fullAddress.split(' - ');
            
            if (dashParts.length >= 2) {
              // Tem " - ", ent√£o: "Rua X, 123" - "Bairro, Cidade"
              const ruaENumero = dashParts[0]; // "Rua X, 123"
              const bairroECidade = dashParts.slice(1).join(' - '); // "Bairro, Cidade"
              
              // Separa rua e n√∫mero por v√≠rgula
              const ruaParts = ruaENumero.split(',').map(p => p.trim());
              if (ruaParts.length >= 2) {
                setStreet(ruaParts[0]); // "Rua X"
                setNumber(ruaParts[1]); // "123"
              } else {
                setStreet(ruaParts[0]);
              }
              
              // Separa bairro e cidade por v√≠rgula
              const bairroParts = bairroECidade.split(',').map(p => p.trim());
              if (bairroParts.length >= 2) {
                setNeighborhood(bairroParts[0]); // "Bairro"
                setCity(bairroParts[1]); // "Cidade"
              } else if (bairroParts.length === 1) {
                setNeighborhood(bairroParts[0]);
              }
            } else {
              // N√£o tem " - ", tenta separar s√≥ por v√≠rgula
              const parts = fullAddress.split(',').map(p => p.trim());
              if (parts.length >= 1) setStreet(parts[0]);
              if (parts.length >= 2) setNumber(parts[1]);
              if (parts.length >= 3) setNeighborhood(parts[2]);
              if (parts.length >= 4) setCity(parts[3]);
            }
          };
          
          // Autocomplete de Rua
          const handleStreetChange = async (e) => {
            const value = e.target.value;
            setStreet(value);
            
            const suggestions = await searchPhoton(value, 'street');
            setStreetSuggestions(suggestions);
            setShowStreetSuggestions(suggestions.length > 0);
          };
          
          // Autocomplete de Bairro
          const handleNeighborhoodChange = async (e) => {
            const value = e.target.value;
            setNeighborhood(value);
            
            const suggestions = await searchPhoton(value, 'neighborhood');
            setNeighborhoodSuggestions(suggestions);
            setShowNeighborhoodSuggestions(suggestions.length > 0);
          };
          
          // Autocomplete de Cidade
          const handleCityChange = async (e) => {
            const value = e.target.value;
            setCity(value);
            
            const suggestions = await searchPhoton(value, 'city');
            setCitySuggestions(suggestions);
            setShowCitySuggestions(suggestions.length > 0);
          };
          
          // Monta endere√ßo completo
          const getFullAddress = () => {
            let addr = street;
            if (number) addr += `, ${number}`;
            if (neighborhood) addr += ` - ${neighborhood}`;
            if (city) addr += `, ${city}`;
            return addr;
          };
          
          // Clica em "Entregar em outro endere√ßo"
          const handleUseOtherAddress = () => {
            setUseOtherAddress(true);
            setCep('');
            setStreet('');
            setNumber('');
            setNeighborhood('');
            setCity('Ribeir√£o Preto');
            setComplement('');
          };
          
          // Volta pro endere√ßo do cadastro
          const handleUseCadastroAddress = () => {
            setUseOtherAddress(false);
            if (foundCustomer?.address) {
              parseAddress(foundCustomer.address);
            }
            setComplement(foundCustomer?.complement || '');
          };
          
          // Busca card√°pio
          useEffect(() => {
            const fetchMenu = async () => {
              try {
                const res = await authFetch(`${API_URL}/menu/full`);
                if (res.ok) {
                  const data = await res.json();
                  setMenuData(data);
                  setSelectedItemId('');
                }
              } catch (err) {
                console.error('Erro ao buscar card√°pio:', err);
              }
              setLoadingMenu(false);
            };
            fetchMenu();
          }, []);
          
          const getSelectedItem = () => {
            for (const cat of menuData) {
              const item = cat.items.find(i => i.id === selectedItemId);
              if (item) return { ...item, categoryName: cat.name };
            }
            return null;
          };
          
          // Cria pedido
          const createOrder = async (e) => {
            e.preventDefault();
            
            if (!customerName.trim()) {
              setErrorMsg('Digite o nome do cliente');
              return;
            }
            if (!selectedItemId) {
              setErrorMsg('Selecione um item do card√°pio');
              return;
            }
            if (!street.trim()) {
              setErrorMsg('Digite a rua');
              return;
            }
            if (!number.trim()) {
              setErrorMsg('Digite o n√∫mero');
              return;
            }
            if (!city.trim()) {
              setErrorMsg('Digite a cidade');
              return;
            }
            
            const fullAddress = getFullAddress();
            const selectedItem = getSelectedItem();
            
            setLoading(true);
            setErrorMsg('');
            setStatus('üîç Buscando coordenadas...');
            
            try {
              // Se √© cliente novo, salva primeiro
              if (!foundCustomer && phone.replace(/\D/g, '').length >= 10) {
                try {
                  await authFetch(`${API_URL}/customers`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                      phone: phone.replace(/\D/g, ''),
                      name: customerName.trim(),
                      address: fullAddress,
                      complement: complement.trim() || null
                    })
                  });
                } catch (err) {
                  // Ignora se j√° existe
                }
              }
              
              // Cria pedido (endere√ßo vai no PEDIDO, n√£o atualiza cadastro!)
              const res = await authFetch(`${API_URL}/orders`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  customer_name: customerName.trim(),
                  address_text: fullAddress + (complement ? ` - ${complement}` : ''),
                  item: selectedItem ? selectedItem.name : 'Pedido',
                  prep_type: 'short',
                  simulated_date: simulatedDate,
                }),
              });
              
              if (!res.ok) {
                const error = await res.json();
                throw new Error(error.detail || 'Erro ao criar pedido');
              }
              
              setStatus('‚úÖ Pedido criado com sucesso!');
              // Limpa formul√°rio
              setPhone('');
              setCustomerName('');
              setCep('');
              setStreet('');
              setNumber('');
              setNeighborhood('');
              setCity('Ribeir√£o Preto');
              setComplement('');
              setFoundCustomer(null);
              setUseOtherAddress(false);
              onOrderCreated();
              
              setTimeout(() => setStatus(''), 3000);
              
            } catch (err) {
              console.error('Erro:', err);
              setErrorMsg(`‚ùå ${err.message}`);
            }
            
            setLoading(false);
          };
          
          const formatPrice = (price) => {
            return new Intl.NumberFormat('pt-BR', {
              style: 'currency',
              currency: 'BRL'
            }).format(price);
          };
          
          const hasMenuItems = menuData.some(cat => cat.items.length > 0);
          
          // Mostra campos separados quando: cliente novo OU clicou em "outro endere√ßo"
          const showAddressFields = !foundCustomer || useOtherAddress;
          
          return (
            <Card className="p-4 mb-6">
              <h3 className="font-semibold text-gray-700 mb-4 flex items-center gap-2">
                üìù Novo Pedido
                <span className="text-xs font-normal text-green-600 bg-green-50 px-2 py-0.5 rounded">
                  Google Maps
                </span>
              </h3>
              
              <form onSubmit={createOrder} className="space-y-4">
                {/* Telefone */}
                <div>
                  <label className="block text-sm font-medium text-gray-600 mb-1">
                    Telefone do Cliente
                    {searchingCustomer && <span className="ml-2 text-orange-500">üîç Buscando...</span>}
                  </label>
                  <input
                    type="tel"
                    value={phone}
                    onChange={handlePhoneChange}
                    placeholder="(16) 99999-1234"
                    className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-orange-500 outline-none"
                    maxLength={15}
                    disabled={loading}
                  />
                </div>
                
                {/* CARD DO CLIENTE ENCONTRADO */}
                {foundCustomer && !useOtherAddress && (
                  <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                    <div className="flex items-start gap-3">
                      <span className="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center text-white font-bold text-lg">
                        {foundCustomer.name.charAt(0).toUpperCase()}
                      </span>
                      <div className="flex-1">
                        <div className="font-semibold text-gray-800">{foundCustomer.name}</div>
                        <div className="text-sm text-gray-600 mt-1">
                          üìç {foundCustomer.address}
                        </div>
                        {foundCustomer.complement && (
                          <div className="text-sm text-gray-500">
                            üè† {foundCustomer.complement}
                          </div>
                        )}
                      </div>
                    </div>
                    <button
                      type="button"
                      onClick={handleUseOtherAddress}
                      className="mt-3 w-full py-2 text-sm text-orange-600 bg-orange-50 hover:bg-orange-100 rounded-lg transition-colors"
                    >
                      üìç Entregar em outro endere√ßo
                    </button>
                  </div>
                )}
                
                {/* ALERTA: Outro endere√ßo */}
                {foundCustomer && useOtherAddress && (
                  <div className="bg-yellow-50 border border-yellow-200 rounded-lg p-3 text-sm">
                    <div className="flex items-center justify-between">
                      <span className="text-yellow-700">‚ö†Ô∏è Entrega em endere√ßo diferente do cadastro</span>
                      <button
                        type="button"
                        onClick={handleUseCadastroAddress}
                        className="text-blue-600 hover:underline text-xs"
                      >
                        ‚Ü©Ô∏è Usar endere√ßo do cadastro
                      </button>
                    </div>
                  </div>
                )}
                
                {/* Nome - s√≥ mostra se n√£o encontrou cliente */}
                {!foundCustomer && (
                  <div className="relative">
                    <label className="block text-sm font-medium text-gray-600 mb-1">
                      Nome do Cliente
                    </label>
                    <input
                      type="text"
                      value={customerName}
                      onChange={handleNameChange}
                      onBlur={() => setTimeout(() => setShowNameSuggestions(false), 200)}
                      onFocus={() => nameSuggestions.length > 0 && setShowNameSuggestions(true)}
                      placeholder="Digite o nome..."
                      className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none"
                      disabled={loading}
                      autoComplete="off"
                    />
                    
                    {showNameSuggestions && nameSuggestions.length > 0 && (
                      <div className="absolute z-20 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg max-h-48 overflow-y-auto">
                        {nameSuggestions.map(customer => (
                          <button
                            key={customer.id}
                            type="button"
                            onClick={() => selectCustomer(customer)}
                            className="w-full px-3 py-2 text-left hover:bg-orange-50 flex items-center gap-3 border-b border-gray-100 last:border-0"
                          >
                            <span className="w-8 h-8 bg-orange-100 rounded-full flex items-center justify-center text-orange-600 font-bold text-sm">
                              {customer.name.charAt(0).toUpperCase()}
                            </span>
                            <div className="flex-1 min-w-0">
                              <div className="font-medium text-gray-800 truncate">{customer.name}</div>
                              <div className="text-xs text-gray-500 truncate">üìû {customer.phone}</div>
                            </div>
                          </button>
                        ))}
                      </div>
                    )}
                    
                    {phone.replace(/\D/g, '').length >= 10 && (
                      <p className="text-xs text-blue-600 mt-1">üìù Cliente novo - ser√° cadastrado automaticamente</p>
                    )}
                  </div>
                )}
                
                {/* Item do Card√°pio */}
                <div>
                  <label className="block text-sm font-medium text-gray-600 mb-1">Item</label>
                  
                  {loadingMenu ? (
                    <div className="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-gray-400">
                      Carregando card√°pio...
                    </div>
                  ) : hasMenuItems ? (
                    <select
                      value={selectedItemId}
                      onChange={(e) => setSelectedItemId(e.target.value)}
                      className={`w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-orange-500 outline-none bg-white ${!selectedItemId ? 'text-gray-400' : 'text-gray-800'}`}
                      disabled={loading}
                    >
                      <option value="" disabled>Selecione um item...</option>
                      {menuData.map(category => (
                        <optgroup key={category.id} label={category.name}>
                          {category.items.map(item => (
                            <option key={item.id} value={item.id} disabled={item.out_of_stock}>
                              {item.name} - {formatPrice(item.price)} {item.out_of_stock ? '(Esgotado)' : ''}
                            </option>
                          ))}
                        </optgroup>
                      ))}
                    </select>
                  ) : (
                    <div className="w-full px-3 py-2 border border-orange-300 rounded-lg bg-orange-50 text-orange-600 text-sm">
                      ‚ö†Ô∏è Nenhum item. <a href="/cardapio" className="underline">Cadastrar card√°pio</a>
                    </div>
                  )}
                </div>
                
                {/* ========== CAMPOS DE ENDERE√áO SEPARADOS ========== */}
                {showAddressFields && (
                  <>
                    {/* CEP */}
                    <div>
                      <label className="block text-sm font-medium text-gray-600 mb-1">
                        CEP
                        {loadingCep && <span className="ml-2 text-orange-500">üîç Buscando...</span>}
                      </label>
                      <input
                        type="text"
                        value={cep}
                        onChange={handleCepChange}
                        placeholder="14090-000"
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none"
                        maxLength={9}
                        disabled={loading}
                      />
                      <p className="text-xs text-gray-400 mt-1">Digite o CEP para preencher automaticamente</p>
                    </div>
                    
                    {/* Rua */}
                    <div className="relative">
                      <label className="block text-sm font-medium text-gray-600 mb-1">Rua *</label>
                      <input
                        type="text"
                        value={street}
                        onChange={handleStreetChange}
                        onBlur={() => setTimeout(() => setShowStreetSuggestions(false), 200)}
                        onFocus={() => streetSuggestions.length > 0 && setShowStreetSuggestions(true)}
                        placeholder="Ex: Rua Rangel Pestana"
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none"
                        disabled={loading}
                        autoComplete="off"
                      />
                      {showStreetSuggestions && streetSuggestions.length > 0 && (
                        <div className="absolute z-20 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg max-h-40 overflow-y-auto">
                          {streetSuggestions.map((s, i) => (
                            <button key={i} type="button" onClick={() => { setStreet(s); setShowStreetSuggestions(false); }}
                              className="w-full px-3 py-2 text-left hover:bg-orange-50 text-sm border-b border-gray-100 last:border-0">
                              üìç {s}
                            </button>
                          ))}
                        </div>
                      )}
                    </div>
                    
                    {/* N√∫mero + Bairro (lado a lado) */}
                    <div className="grid grid-cols-3 gap-3">
                      <div>
                        <label className="block text-sm font-medium text-gray-600 mb-1">N√∫mero *</label>
                        <input
                          id="numberInput"
                          type="text"
                          value={number}
                          onChange={(e) => setNumber(e.target.value)}
                          placeholder="834"
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none"
                          disabled={loading}
                        />
                      </div>
                      
                      <div className="col-span-2 relative">
                        <label className="block text-sm font-medium text-gray-600 mb-1">Bairro</label>
                        <input
                          type="text"
                          value={neighborhood}
                          onChange={handleNeighborhoodChange}
                          onBlur={() => setTimeout(() => setShowNeighborhoodSuggestions(false), 200)}
                          onFocus={() => neighborhoodSuggestions.length > 0 && setShowNeighborhoodSuggestions(true)}
                          placeholder="Ex: Vila Virginia"
                          className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none"
                          disabled={loading}
                          autoComplete="off"
                        />
                        {showNeighborhoodSuggestions && neighborhoodSuggestions.length > 0 && (
                          <div className="absolute z-20 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg max-h-40 overflow-y-auto">
                            {neighborhoodSuggestions.map((s, i) => (
                              <button key={i} type="button" onClick={() => { setNeighborhood(s); setShowNeighborhoodSuggestions(false); }}
                                className="w-full px-3 py-2 text-left hover:bg-orange-50 text-sm border-b border-gray-100 last:border-0">
                                üìç {s}
                              </button>
                            ))}
                          </div>
                        )}
                      </div>
                    </div>
                    
                    {/* Cidade */}
                    <div className="relative">
                      <label className="block text-sm font-medium text-gray-600 mb-1">Cidade *</label>
                      <input
                        type="text"
                        value={city}
                        onChange={handleCityChange}
                        onBlur={() => setTimeout(() => setShowCitySuggestions(false), 200)}
                        onFocus={() => citySuggestions.length > 0 && setShowCitySuggestions(true)}
                        placeholder="Ex: Ribeir√£o Preto"
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none"
                        disabled={loading}
                        autoComplete="off"
                      />
                      {showCitySuggestions && citySuggestions.length > 0 && (
                        <div className="absolute z-20 w-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg max-h-40 overflow-y-auto">
                          {citySuggestions.map((s, i) => (
                            <button key={i} type="button" onClick={() => { setCity(s); setShowCitySuggestions(false); }}
                              className="w-full px-3 py-2 text-left hover:bg-orange-50 text-sm border-b border-gray-100 last:border-0">
                              üìç {s}
                            </button>
                          ))}
                        </div>
                      )}
                    </div>
                    
                    {/* Complemento */}
                    <div>
                      <label className="block text-sm font-medium text-gray-600 mb-1">
                        Complemento <span className="text-gray-400 font-normal">(opcional)</span>
                      </label>
                      <input
                        type="text"
                        value={complement}
                        onChange={(e) => setComplement(e.target.value)}
                        placeholder="Apto 45, Bloco B, Port√£o azul..."
                        className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 outline-none"
                        disabled={loading}
                      />
                    </div>
                  </>
                )}
                
                {/* Bot√£o */}
                <Button type="submit" disabled={loading || (!hasMenuItems && !loadingMenu)} className="w-full">
                  {loading ? '‚è≥ Criando...' : '‚úì Criar Pedido'}
                </Button>
              </form>
              
              {status && <p className="text-sm text-green-600 mt-3 text-center animate-pulse">{status}</p>}
              {errorMsg && <p className="text-sm text-red-600 mt-3 text-center">{errorMsg}</p>}
            </Card>
          );
        };
        
        // ============ LISTA DE PEDIDOS ============
        
        const OrdersList = ({ orders, onRefresh }) => {
          const pendingOrders = orders.filter(o => ['created', 'preparing'].includes(o.status));
          const readyOrders = orders.filter(o => o.status === 'ready');
          const inRouteOrders = orders.filter(o => ['assigned', 'picked_up'].includes(o.status));
          
          const handleScan = async (orderId) => {
            try {
              await authFetch(`${API_URL}/orders/${orderId}/scan`, { method: 'POST' });
              onRefresh();
            } catch (err) {
              console.error('Erro ao bipar:', err);
            }
          };
          
          const OrderCard = ({ order, showScan = false }) => (
            <div className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
              <div className="flex-1">
                <div className="flex items-center gap-2 flex-wrap">
                  <span className="font-medium text-gray-800">{order.customer_name}</span>
                  <StatusBadge status={order.status} />
                  {order.prep_type === 'long' && (
                    <span className="text-xs bg-yellow-100 text-yellow-700 px-2 py-0.5 rounded">Demorado</span>
                  )}
                  {/* Cron√¥metro - mostra desde cria√ß√£o at√© ficar pronto */}
                  {['created', 'preparing'].includes(order.status) && order.created_at && (
                    <Timer startTime={order.created_at} />
                  )}
                  {/* Cron√¥metro - mostra tempo esperando motoboy */}
                  {order.status === 'ready' && order.ready_at && (
                    <Timer startTime={order.ready_at} />
                  )}
                </div>
                <div className="text-sm text-gray-500 mt-1">{order.address_text}</div>
                {order.stop_order && (
                  <div className="text-xs text-blue-600 mt-1">Parada #{order.stop_order}</div>
                )}
              </div>
              {showScan && (
                <Button onClick={() => handleScan(order.id)} variant="success" className="ml-2">
                  üì± Bipar
                </Button>
              )}
            </div>
          );
          
          return (
            <div className="grid md:grid-cols-3 gap-4 mb-6">
              <Card className="p-4">
                <h3 className="font-semibold text-gray-700 mb-3">
                  üßë‚Äçüç≥ Em Preparo ({pendingOrders.length})
                </h3>
                <div className="space-y-2 max-h-64 overflow-y-auto">
                  {pendingOrders.length === 0 ? (
                    <p className="text-sm text-gray-400 text-center py-4">Nenhum pedido</p>
                  ) : (
                    pendingOrders.map(order => (
                      <OrderCard key={order.id} order={order} showScan={true} />
                    ))
                  )}
                </div>
              </Card>
              
              <Card className="p-4 border-2 border-green-200">
                <h3 className="font-semibold text-green-700 mb-3">
                  ‚úÖ Prontos ({readyOrders.length})
                </h3>
                <div className="space-y-2 max-h-64 overflow-y-auto">
                  {readyOrders.length === 0 ? (
                    <p className="text-sm text-gray-400 text-center py-4">Nenhum pedido</p>
                  ) : (
                    readyOrders.map(order => (
                      <OrderCard key={order.id} order={order} />
                    ))
                  )}
                </div>
              </Card>
              
              <Card className="p-4">
                <h3 className="font-semibold text-blue-700 mb-3">
                  üèçÔ∏è Em Rota ({inRouteOrders.length})
                </h3>
                <div className="space-y-2 max-h-64 overflow-y-auto">
                  {inRouteOrders.length === 0 ? (
                    <p className="text-sm text-gray-400 text-center py-4">Nenhum pedido</p>
                  ) : (
                    inRouteOrders.map(order => (
                      <OrderCard key={order.id} order={order} />
                    ))
                  )}
                </div>
              </Card>
            </div>
          );
        };
        
        // ============ PAINEL DE MOTOQUEIROS ============
        
        const CouriersPanel = ({ couriers, onRefresh }) => {
          const [newName, setNewName] = useState('');
          const [showInviteModal, setShowInviteModal] = useState(false);
          const [inviteData, setInviteData] = useState(null);
          const [inviteLoading, setInviteLoading] = useState(false);
          const [copySuccess, setCopySuccess] = useState(false);
          
          // Estados para recupera√ß√£o de senha
          const [showResetModal, setShowResetModal] = useState(false);
          const [resetData, setResetData] = useState(null);
          const [resetLoading, setResetLoading] = useState(false);
          const [resetCopySuccess, setResetCopySuccess] = useState(false);
          
          // Menu de op√ß√µes do motoboy
          const [openMenuId, setOpenMenuId] = useState(null);
          
          const createCourier = async () => {
            if (!newName.trim()) return;
            try {
              await authFetch(`${API_URL}/couriers`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: newName }),
              });
              setNewName('');
              onRefresh();
            } catch (err) {
              console.error('Erro:', err);
            }
          };
          
          const toggleStatus = async (courier) => {
            const endpoint = courier.status === 'available' 
              ? `${API_URL}/couriers/${courier.id}/offline`
              : `${API_URL}/couriers/${courier.id}/available`;
            try {
              await authFetch(endpoint, { method: 'POST' });
              onRefresh();
            } catch (err) {
              console.error('Erro:', err);
            }
          };
          
          const completeBatch = async (courierId) => {
            try {
              await authFetch(`${API_URL}/couriers/${courierId}/complete-batch`, { method: 'POST' });
              onRefresh();
            } catch (err) {
              console.error('Erro:', err);
            }
          };
          
          // Criar convite
          const createInvite = async () => {
            setInviteLoading(true);
            try {
              const token = localStorage.getItem('motoflash_token');
              const res = await fetch(`${API_URL}/invites`, {
                method: 'POST',
                headers: { 
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${token}`
                }
              });
              
              if (res.ok) {
                const data = await res.json();
                setInviteData(data);
                setShowInviteModal(true);
              } else {
                alert('Erro ao criar convite. Fa√ßa login novamente.');
              }
            } catch (err) {
              console.error('Erro ao criar convite:', err);
              alert('Erro ao criar convite');
            }
            setInviteLoading(false);
          };
          
          // Gerar link de recupera√ß√£o de senha
          const createPasswordReset = async (courier) => {
            setResetLoading(true);
            setOpenMenuId(null);
            try {
              const token = localStorage.getItem('motoflash_token');
              const res = await fetch(`${API_URL}/couriers/${courier.id}/password-reset`, {
                method: 'POST',
                headers: { 
                  'Content-Type': 'application/json',
                  'Authorization': `Bearer ${token}`
                }
              });
              
              if (res.ok) {
                const data = await res.json();
                setResetData(data);
                setShowResetModal(true);
              } else {
                alert('Erro ao gerar link de recupera√ß√£o.');
              }
            } catch (err) {
              console.error('Erro ao gerar link:', err);
              alert('Erro ao gerar link de recupera√ß√£o');
            }
            setResetLoading(false);
          };
          
          // Copiar link de convite
          const copyLink = () => {
            if (inviteData?.invite_url) {
              navigator.clipboard.writeText(inviteData.invite_url);
              setCopySuccess(true);
              setTimeout(() => setCopySuccess(false), 2000);
            }
          };
          
          // Copiar link de recupera√ß√£o
          const copyResetLink = () => {
            if (resetData?.reset_url) {
              navigator.clipboard.writeText(resetData.reset_url);
              setResetCopySuccess(true);
              setTimeout(() => setResetCopySuccess(false), 2000);
            }
          };
          
          // Compartilhar convite no WhatsApp
          const shareWhatsApp = () => {
            if (inviteData?.invite_url) {
              const text = `üèçÔ∏è Voc√™ foi convidado para fazer entregas!\n\nClique no link para entrar na equipe:\n${inviteData.invite_url}`;
              window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
            }
          };
          
          // Compartilhar recupera√ß√£o no WhatsApp
          const shareResetWhatsApp = () => {
            if (resetData?.reset_url) {
              const text = `üîë Link para redefinir sua senha no MotoFlash:\n\n${resetData.reset_url}\n\n‚è±Ô∏è V√°lido por ${resetData.expires_in}`;
              window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
            }
          };
          
          return (
            <Card className="p-4 mb-6">
              <h3 className="font-semibold text-gray-700 mb-3">
                üèçÔ∏è Motoqueiros ({couriers.length})
              </h3>
              
              {/* Bot√£o de Convite - Principal */}
              <button
                onClick={createInvite}
                disabled={inviteLoading}
                className="w-full mb-3 py-2.5 px-4 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white rounded-lg font-medium flex items-center justify-center gap-2 transition-all disabled:opacity-50"
              >
                {inviteLoading ? (
                  <>
                    <svg className="animate-spin h-4 w-4" viewBox="0 0 24 24">
                      <circle className="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" strokeWidth="4" fill="none" />
                      <path className="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4z" />
                    </svg>
                    Gerando...
                  </>
                ) : (
                  <>üì≤ Convidar Motoboy via Link</>
                )}
              </button>
              
              {/* Input manual (alternativa) */}
              <div className="flex gap-2 mb-4">
                <input
                  type="text"
                  value={newName}
                  onChange={(e) => setNewName(e.target.value)}
                  placeholder="Ou digite o nome..."
                  className="flex-1 px-3 py-2 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-orange-500 text-sm"
                  onKeyPress={(e) => e.key === 'Enter' && createCourier()}
                />
                <Button onClick={createCourier} disabled={!newName.trim()} className="text-sm">
                  Adicionar
                </Button>
              </div>
              
              {/* Lista de Motoboys */}
              <div className="space-y-2">
                {couriers.length === 0 ? (
                  <p className="text-sm text-gray-400 text-center py-4">
                    Nenhum motoboy. Convide pelo bot√£o acima!
                  </p>
                ) : (
                  couriers.map(courier => (
                    <div key={courier.id} className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                      <div className="flex items-center gap-3">
                        <div className="w-10 h-10 bg-orange-100 rounded-full flex items-center justify-center text-orange-600 font-bold">
                          {courier.name.charAt(0).toUpperCase()}
                        </div>
                        <div>
                          <div className="font-medium text-gray-800">{courier.name}</div>
                          <StatusBadge status={courier.status} />
                        </div>
                      </div>
                      <div className="flex gap-2 items-center">
                        {courier.status === 'busy' && (
                          <Button onClick={() => completeBatch(courier.id)} variant="success" className="text-sm">
                            ‚úì Finalizar
                          </Button>
                        )}
                        <Button 
                          onClick={() => toggleStatus(courier)} 
                          variant="secondary"
                          className="text-sm"
                          disabled={courier.status === 'busy'}
                        >
                          {courier.status === 'available' ? 'Pausar' : 'Ativar'}
                        </Button>
                        
                        {/* Menu de Op√ß√µes */}
                        <div className="relative">
                          <button
                            onClick={() => setOpenMenuId(openMenuId === courier.id ? null : courier.id)}
                            className="p-2 text-gray-400 hover:text-gray-600 hover:bg-gray-200 rounded-lg transition-all"
                          >
                            ‚ãÆ
                          </button>
                          
                          {openMenuId === courier.id && (
                            <>
                              {/* Overlay invis√≠vel para fechar ao clicar fora */}
                              <div 
                                className="fixed inset-0 z-[5]" 
                                onClick={() => setOpenMenuId(null)}
                              />
                              <div className="absolute right-0 top-full mt-1 bg-white border border-gray-200 rounded-lg shadow-lg z-10 min-w-[160px]">
                                <button
                                  onClick={() => createPasswordReset(courier)}
                                  disabled={resetLoading}
                                  className="w-full px-4 py-2 text-left text-sm text-gray-700 hover:bg-gray-50 flex items-center gap-2"
                                >
                                  üîë Recuperar Senha
                                </button>
                              </div>
                            </>
                          )}
                        </div>
                      </div>
                    </div>
                  ))
                )}
              </div>
              
              {/* Modal de Convite */}
              {showInviteModal && inviteData && (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                  <div className="bg-white rounded-2xl shadow-xl max-w-sm w-full p-6 relative">
                    {/* Bot√£o Fechar */}
                    <button 
                      onClick={() => setShowInviteModal(false)}
                      className="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-xl"
                    >
                      ‚úï
                    </button>
                    
                    {/* Conte√∫do */}
                    <div className="text-center">
                      <div className="text-4xl mb-3">üì≤</div>
                      <h3 className="text-lg font-bold text-gray-800 mb-1">
                        Convite Criado!
                      </h3>
                      <p className="text-sm text-gray-500 mb-4">
                        ‚è±Ô∏è V√°lido por {inviteData.time_remaining}
                      </p>
                      
                      {/* Link */}
                      <div className="bg-gray-100 rounded-lg p-3 mb-4">
                        <p className="text-xs text-gray-500 mb-1">Link do convite:</p>
                        <p className="text-sm font-mono text-gray-700 break-all">
                          {inviteData.invite_url}
                        </p>
                      </div>
                      
                      {/* Bot√µes de A√ß√£o */}
                      <div className="space-y-2">
                        <button
                          onClick={shareWhatsApp}
                          className="w-full py-3 px-4 bg-green-500 hover:bg-green-600 text-white rounded-xl font-semibold flex items-center justify-center gap-2"
                        >
                          <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                          </svg>
                          Enviar por WhatsApp
                        </button>
                        
                        <button
                          onClick={copyLink}
                          className={`w-full py-3 px-4 rounded-xl font-semibold flex items-center justify-center gap-2 transition-all ${
                            copySuccess 
                              ? 'bg-green-100 text-green-700' 
                              : 'bg-gray-200 hover:bg-gray-300 text-gray-700'
                          }`}
                        >
                          {copySuccess ? '‚úì Link Copiado!' : 'üìã Copiar Link'}
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              )}
              
              {/* Modal de Recupera√ß√£o de Senha */}
              {showResetModal && resetData && (
                <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
                  <div className="bg-white rounded-2xl shadow-xl max-w-sm w-full p-6 relative">
                    <button 
                      onClick={() => setShowResetModal(false)}
                      className="absolute top-4 right-4 text-gray-400 hover:text-gray-600 text-xl"
                    >
                      ‚úï
                    </button>
                    
                    <div className="text-center">
                      <div className="text-4xl mb-3">üîë</div>
                      <h3 className="text-lg font-bold text-gray-800 mb-1">
                        Link de Recupera√ß√£o
                      </h3>
                      <p className="text-sm text-gray-500 mb-4">
                        Para: <strong>{resetData.courier_name}</strong><br/>
                        ‚è±Ô∏è V√°lido por {resetData.expires_in}
                      </p>
                      
                      <div className="bg-gray-100 rounded-lg p-3 mb-4">
                        <p className="text-xs text-gray-500 mb-1">Link:</p>
                        <p className="text-sm font-mono text-gray-700 break-all">
                          {resetData.reset_url}
                        </p>
                      </div>
                      
                      <div className="space-y-2">
                        <button
                          onClick={shareResetWhatsApp}
                          className="w-full py-3 px-4 bg-green-500 hover:bg-green-600 text-white rounded-xl font-semibold flex items-center justify-center gap-2"
                        >
                          <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                            <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893a11.821 11.821 0 00-3.48-8.413z"/>
                          </svg>
                          Enviar por WhatsApp
                        </button>
                        
                        <button
                          onClick={copyResetLink}
                          className={`w-full py-3 px-4 rounded-xl font-semibold flex items-center justify-center gap-2 transition-all ${
                            resetCopySuccess 
                              ? 'bg-green-100 text-green-700' 
                              : 'bg-gray-200 hover:bg-gray-300 text-gray-700'
                          }`}
                        >
                          {resetCopySuccess ? '‚úì Link Copiado!' : 'üìã Copiar Link'}
                        </button>
                      </div>
                    </div>
                  </div>
                </div>
              )}
            </Card>
          );
        };
        
        // ============ CONTROLE DE DISPATCH ============
        
        const DispatchControl = ({ onDispatch, stats }) => {
          const [loading, setLoading] = useState(false);
          const [lastResult, setLastResult] = useState(null);
          
          const runDispatch = async () => {
            setLoading(true);
            try {
              const res = await authFetch(`${API_URL}/dispatch/run`, { method: 'POST' });
              const result = await res.json();
              setLastResult(result);
              onDispatch();
            } catch (err) {
              setLastResult({ message: 'Erro ao executar dispatch' });
            }
            setLoading(false);
          };
          
          const canDispatch = stats && stats.orders?.ready > 0 && stats.couriers?.available > 0;
          
          return (
            <Card className="p-4 mb-6 border-2 border-orange-200 bg-orange-50">
              <div className="flex items-center justify-between flex-wrap gap-4">
                <div>
                  <h3 className="font-semibold text-orange-700">
                    üöÄ Dispatch - Distribuir Pedidos
                  </h3>
                  <p className="text-sm text-orange-600 mt-1">
                    {stats?.orders?.ready || 0} pronto(s) ¬∑ {stats?.couriers?.available || 0} motoboy(s)
                  </p>
                </div>
                <Button 
                  onClick={runDispatch} 
                  disabled={loading || !canDispatch}
                  className="text-lg px-6 py-3"
                >
                  {loading ? '‚è≥...' : 'üöÄ Executar'}
                </Button>
              </div>
              
              {lastResult && (
                <div className={`mt-3 p-3 rounded-lg ${lastResult.batches_created > 0 ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600'}`}>
                  {lastResult.message}
                </div>
              )}
            </Card>
          );
        };
        
        // ============ LOTES ATIVOS ============
        
        const ActiveBatches = ({ batches }) => {
          if (!batches || batches.length === 0) return null;
          
          return (
            <Card className="p-4 mb-6">
              <h3 className="font-semibold text-gray-700 mb-3">
                üì¶ Lotes Ativos ({batches.length})
              </h3>
              <div className="space-y-3">
                {batches.map(batch => (
                  <div key={batch.id} className="p-3 bg-blue-50 rounded-lg border border-blue-200">
                    <div className="flex items-center justify-between mb-2">
                      <span className="font-medium text-blue-800">
                        üèçÔ∏è {batch.courier_name}
                      </span>
                      <StatusBadge status={batch.status} />
                    </div>
                    <div className="space-y-1">
                      {batch.orders.map((order, idx) => (
                        <div key={order.id} className="text-sm text-gray-600 flex items-center gap-2">
                          <span className="w-5 h-5 bg-blue-200 rounded-full flex items-center justify-center text-xs font-bold text-blue-700">
                            {idx + 1}
                          </span>
                          {order.customer_name} - {order.address_text.split(' - ')[0]}
                        </div>
                      ))}
                    </div>
                  </div>
                ))}
              </div>
            </Card>
          );
        };
        
        // ============ APP PRINCIPAL ============
        
        function MotoFlashApp() {
          const [orders, setOrders] = useState([]);
          const [couriers, setCouriers] = useState([]);
          const [batches, setBatches] = useState([]);
          const [stats, setStats] = useState(null);
          const [alerts, setAlerts] = useState(null);
          const [recommendation, setRecommendation] = useState(null);
          const [connected, setConnected] = useState(false);
          const [error, setError] = useState(null);
          
          // Dados do usu√°rio logado
          const [restaurantName, setRestaurantName] = useState(() => {
            const restaurantData = localStorage.getItem('motoflash_restaurant');
            if (restaurantData) {
              try {
                const restaurant = JSON.parse(restaurantData);
                return restaurant.name || 'Restaurante';
              } catch {
                return 'Restaurante';
              }
            }
            return 'Restaurante';
          });
          
          // Fun√ß√£o de logout
          const handleLogout = () => {
            localStorage.removeItem('motoflash_token');
            localStorage.removeItem('motoflash_user');
            window.location.href = '/login';
          };
          
          // Data simulada para testes
          const [simulatedDate, setSimulatedDate] = useState(() => {
            const today = new Date();
            return today.toISOString().split('T')[0]; // formato YYYY-MM-DD
          });
          
          const fetchAll = useCallback(async () => {
            try {
              const [ordersRes, couriersRes, batchesRes, statsRes, alertsRes, recoRes] = await Promise.all([
                authFetch(`${API_URL}/orders?limit=50`),
                authFetch(`${API_URL}/couriers`),  // üîí Agora protegido
                authFetch(`${API_URL}/dispatch/batches`),
                authFetch(`${API_URL}/dispatch/stats`),
                authFetch(`${API_URL}/dispatch/alerts`),
                authFetch(`${API_URL}/dispatch/recommendation`),
              ]);
              
              if (ordersRes.ok) setOrders(await ordersRes.json());
              if (couriersRes.ok) setCouriers(await couriersRes.json());
              if (batchesRes.ok) setBatches(await batchesRes.json());
              if (statsRes.ok) setStats(await statsRes.json());
              if (alertsRes.ok) setAlerts(await alertsRes.json());
              if (recoRes.ok) setRecommendation(await recoRes.json());
              
              setConnected(true);
              setError(null);
            } catch (err) {
              if (err.message === 'N√£o autenticado' || err.message === 'Sess√£o expirada') {
                return; // J√° redirecionou
              }
              setConnected(false);
              setError('N√£o foi poss√≠vel conectar ao servidor.');
            }
          }, []);
          
          useEffect(() => {
            fetchAll();
            const interval = setInterval(fetchAll, 5000);
            return () => clearInterval(interval);
          }, [fetchAll]);
          
          return (
            <div className="min-h-screen bg-gradient-to-br from-orange-50 to-amber-50">
              {/* Header */}
              <header className="bg-white shadow-sm border-b border-orange-100">
                <div className="max-w-7xl mx-auto px-4 py-4">
                  <div className="flex items-center justify-between flex-wrap gap-4">
                    <div className="flex items-center gap-3">
                      {/* LOGO MOTOFLASH */}
                      <svg width="40" height="40" viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="40" cy="40" r="34" fill="#FF6B00"/>
                        <path d="M44 12 L28 40 L38 40 L32 68 L56 36 L44 36 L52 12 Z" fill="white"/>
                      </svg>
                      <div>
                        <h1 className="text-xl font-bold text-gray-800">MotoFlash</h1>
                        <p className="text-xs text-gray-500">Despacho Inteligente v0.3</p>
                      </div>
                    </div>
                    
                    {/* Seletor de Data para Simula√ß√£o */}
                    <div className="flex items-center gap-3 bg-purple-50 px-4 py-2 rounded-lg border border-purple-200">
                      <span className="text-purple-700 text-sm font-medium">üìÖ Simular data:</span>
                      <input
                        type="date"
                        value={simulatedDate}
                        onChange={(e) => setSimulatedDate(e.target.value)}
                        className="px-3 py-1 border border-purple-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-purple-400"
                      />
                      <span className="text-xs text-purple-500">
                        {new Date(simulatedDate + 'T12:00:00').toLocaleDateString('pt-BR', { weekday: 'long' })}
                      </span>
                    </div>
                    
                    <div className="flex items-center gap-4">
                      {/* Nome do Restaurante */}
                      <div className="hidden sm:flex items-center gap-2 bg-gray-100 px-3 py-2 rounded-lg">
                        <span className="text-lg">üè™</span>
                        <span className="font-medium text-gray-700">{restaurantName}</span>
                      </div>
                      
                      <a 
                        href="/cardapio" 
                        className="flex items-center gap-2 bg-orange-100 hover:bg-orange-200 text-orange-700 px-4 py-2 rounded-lg font-medium transition-all"
                      >
                        üçΩÔ∏è Card√°pio
                      </a>
                      <a 
                        href="/clientes" 
                        className="flex items-center gap-2 bg-blue-100 hover:bg-blue-200 text-blue-700 px-4 py-2 rounded-lg font-medium transition-all"
                      >
                        üë• Clientes
                      </a>
                      
                      <div className="flex items-center gap-2">
                        <div className={`w-2 h-2 rounded-full ${connected ? 'bg-green-500' : 'bg-red-500'}`} />
                        <span className="text-sm text-gray-500">
                          {connected ? 'Conectado' : 'Desconectado'}
                        </span>
                      </div>
                      
                      {/* Bot√£o Sair */}
                      <button
                        onClick={handleLogout}
                        className="flex items-center gap-2 bg-red-100 hover:bg-red-200 text-red-700 px-4 py-2 rounded-lg font-medium transition-all"
                      >
                        üö™ Sair
                      </button>
                    </div>
                  </div>
                </div>
              </header>
              
              {/* Main */}
              <main className="max-w-7xl mx-auto px-4 py-6">
                {error && (
                  <div className="mb-6 p-4 bg-red-100 border border-red-200 rounded-lg text-red-700">
                    <p className="font-medium">‚ö†Ô∏è Erro de conex√£o</p>
                    <p className="text-sm mt-1">{error}</p>
                    <p className="text-sm mt-2">
                      Execute: <code className="bg-red-200 px-2 py-0.5 rounded">cd backend && uvicorn main:app --reload</code>
                    </p>
                  </div>
                )}
                
                <StatsPanel stats={stats} />
                
                <AlertsPanel alerts={alerts} recommendation={recommendation} />
                
                <div className="grid lg:grid-cols-3 gap-6">
                  <div className="lg:col-span-2">
                    <NewOrderForm onOrderCreated={fetchAll} simulatedDate={simulatedDate} />
                    <DispatchControl onDispatch={fetchAll} stats={stats} />
                    <OrdersList orders={orders} onRefresh={fetchAll} />
                  </div>
                  
                  <div>
                    <CouriersPanel couriers={couriers} onRefresh={fetchAll} />
                    <ActiveBatches batches={batches} />
                  </div>
                </div>
              </main>
              
              <footer className="text-center py-4 text-sm text-gray-400">
                MotoFlash MVP v0.3 - Sistema de Despacho Inteligente com Geocoding Autom√°tico
              </footer>
            </div>
          );
        }
        
        ReactDOM.createRoot(document.getElementById('root')).render(<MotoFlashApp />);
    </script>
</body>
</html>