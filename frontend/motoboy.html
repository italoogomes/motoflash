<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#f97316">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <title>MotoFlash - Motoboy</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React 18 -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Google Maps -->
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDAMV5FvQAEPacHSSBLScr5LIALFQ6qpmU&libraries=geometry"></script>
    
    <style>
        body { 
            font-family: 'Inter', system-ui, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        @keyframes pulse-green {
            0%, 100% { box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(34, 197, 94, 0); }
        }
        .pulse-green {
            animation: pulse-green 2s infinite;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect, useRef, useCallback } = React;
        
        // ============ CONFIGURA√á√ÉO ============
        const API_URL = 'http://localhost:8000';
        
        // Endere√ßo do restaurante - coordenadas ser√£o buscadas via geocoding
        const RESTAURANT_ADDRESS = 'Rua Visconde de Inhauma, 2235 - Jardim Sumar√©';
        
        // Ser√° preenchido pelo geocoding ao carregar a p√°gina
        let RESTAURANT_LOCATION = {
            lat: null,
            lng: null,
            name: 'Restaurante',
            address: RESTAURANT_ADDRESS
        };
        
        // Fun√ß√£o para buscar coordenadas do restaurante via geocoding
        async function loadRestaurantLocation() {
            try {
                const res = await fetch(`${API_URL}/geocode?address=${encodeURIComponent(RESTAURANT_ADDRESS)}`);
                if (res.ok) {
                    const data = await res.json();
                    if (data.found) {
                        RESTAURANT_LOCATION.lat = data.lat;
                        RESTAURANT_LOCATION.lng = data.lng;
                        console.log('üìç Restaurante localizado:', data.lat, data.lng);
                        return true;
                    }
                }
                console.error('‚ùå N√£o foi poss√≠vel geocodificar o endere√ßo do restaurante');
                return false;
            } catch (err) {
                console.error('‚ùå Erro ao buscar localiza√ß√£o do restaurante:', err);
                return false;
            }
        }
        
        // Dist√¢ncia m√≠nima para liberar bot√£o de entrega (em metros)
        const MIN_DISTANCE_TO_DELIVER = 100;
        
        // ============ COMPONENTE LOGO ============
        
        const Logo = ({ size = 40 }) => (
            <svg width={size} height={size} viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="40" cy="40" r="34" fill="#FF6B00"/>
                <path d="M44 12 L28 40 L38 40 L32 68 L56 36 L44 36 L52 12 Z" fill="white"/>
            </svg>
        );
        
        const LogoLight = ({ size = 40 }) => (
            <svg width={size} height={size} viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="40" cy="40" r="34" fill="white"/>
                <path d="M44 12 L28 40 L38 40 L32 68 L56 36 L44 36 L52 12 Z" fill="#FF6B00"/>
            </svg>
        );
        
        // ============ FUN√á√ïES AUXILIARES ============
        
        const calculateDistance = (lat1, lng1, lat2, lng2) => {
            const R = 6371000;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLng = (lng2 - lng1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                      Math.sin(dLng/2) * Math.sin(dLng/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        };
        
        // ============ COMPONENTES AUXILIARES ============
        
        const Button = ({ children, onClick, variant = 'primary', disabled = false, className = '', size = 'normal' }) => {
            const variants = {
                primary: 'bg-orange-500 hover:bg-orange-600 text-white',
                secondary: 'bg-gray-200 hover:bg-gray-300 text-gray-700',
                success: 'bg-green-500 hover:bg-green-600 text-white',
                danger: 'bg-red-500 hover:bg-red-600 text-white',
                navigation: 'bg-blue-500 hover:bg-blue-600 text-white',
            };
            
            const sizes = {
                small: 'px-3 py-1.5 text-sm',
                normal: 'px-4 py-2',
                large: 'px-6 py-3 text-lg',
            };
            
            return (
                <button
                    onClick={onClick}
                    disabled={disabled}
                    className={`${variants[variant]} ${sizes[size]} rounded-xl font-semibold transition-all active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed ${className}`}
                >
                    {children}
                </button>
            );
        };
        
        const Card = ({ children, className = '' }) => (
            <div className={`bg-white rounded-2xl shadow-sm ${className}`}>
                {children}
            </div>
        );
        
        // ============ TELA DE LOGIN ============
        
        const LoginScreen = ({ onLogin }) => {
            const [couriers, setCouriers] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [selectedCourier, setSelectedCourier] = useState(null);
            
            useEffect(() => {
                fetchCouriers();
            }, []);
            
            const fetchCouriers = async () => {
                try {
                    const res = await fetch(`${API_URL}/couriers`);
                    if (!res.ok) throw new Error('Falha ao buscar');
                    const data = await res.json();
                    setCouriers(data);
                    setError(null);
                } catch (err) {
                    setError('N√£o foi poss√≠vel conectar ao servidor');
                }
                setLoading(false);
            };
            
            const handleLogin = () => {
                if (selectedCourier) {
                    localStorage.setItem('motoboy_id', selectedCourier.id);
                    localStorage.setItem('motoboy_name', selectedCourier.name);
                    onLogin(selectedCourier);
                }
            };
            
            if (loading) {
                return (
                    <div className="min-h-screen bg-gradient-to-b from-orange-500 to-orange-600 flex items-center justify-center">
                        <div className="text-center text-white">
                            <div className="mb-4 flex justify-center"><LogoLight size={80} /></div>
                            <div className="text-xl">Carregando...</div>
                        </div>
                    </div>
                );
            }
            
            return (
                <div className="min-h-screen bg-gradient-to-b from-orange-500 to-orange-600 flex flex-col items-center justify-center p-6">
                    <div className="text-center mb-8">
                        <div className="mb-4 flex justify-center"><LogoLight size={80} /></div>
                        <h1 className="text-3xl font-bold text-white">MotoFlash</h1>
                        <p className="text-orange-100 mt-2">App do Motoboy</p>
                    </div>
                    
                    <Card className="w-full max-w-sm p-6">
                        <h2 className="text-lg font-semibold text-gray-700 mb-4 text-center">Selecione seu nome</h2>
                        
                        {error ? (
                            <div className="text-center py-8">
                                <div className="text-4xl mb-2">‚ö†Ô∏è</div>
                                <p className="text-red-500 mb-4">{error}</p>
                                <Button onClick={fetchCouriers}>üîÑ Tentar novamente</Button>
                            </div>
                        ) : couriers.length === 0 ? (
                            <div className="text-center py-8 text-gray-500">
                                <div className="text-4xl mb-2">üòï</div>
                                <p>Nenhum motoboy cadastrado</p>
                            </div>
                        ) : (
                            <>
                                <div className="space-y-2 mb-6 max-h-64 overflow-y-auto">
                                    {couriers.map(courier => (
                                        <button
                                            key={courier.id}
                                            onClick={() => setSelectedCourier(courier)}
                                            className={`w-full p-4 rounded-xl text-left transition-all flex items-center gap-3 ${
                                                selectedCourier?.id === courier.id
                                                    ? 'bg-orange-100 border-2 border-orange-500'
                                                    : 'bg-gray-50 border-2 border-transparent hover:bg-gray-100'
                                            }`}
                                        >
                                            <div className={`w-12 h-12 rounded-full flex items-center justify-center text-xl font-bold ${
                                                selectedCourier?.id === courier.id ? 'bg-orange-500 text-white' : 'bg-gray-200 text-gray-600'
                                            }`}>
                                                {courier.name.charAt(0).toUpperCase()}
                                            </div>
                                            <div>
                                                <div className="font-semibold text-gray-800">{courier.name}</div>
                                                <div className={`text-xs ${courier.status === 'available' ? 'text-green-600' : 'text-orange-600'}`}>
                                                    {courier.status === 'available' ? 'üü¢ Dispon√≠vel' : 'üü† Em entrega'}
                                                </div>
                                            </div>
                                        </button>
                                    ))}
                                </div>
                                <Button onClick={handleLogin} disabled={!selectedCourier} className="w-full" size="large">
                                    Entrar
                                </Button>
                            </>
                        )}
                    </Card>
                    <p className="text-orange-200 text-sm mt-6">MotoFlash v0.3</p>
                </div>
            );
        };
        
        // ============ COMPONENTE DO MAPA (GOOGLE MAPS) ============
        
        const DeliveryMap = ({ orders, restaurantLocation, currentPosition, routeStarted, returningHome }) => {
            const mapRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const markersRef = useRef([]);
            const routeLineRef = useRef(null);
            const positionMarkerRef = useRef(null);
            const directionsRendererRef = useRef(null);
            const userInteractedRef = useRef(false); // Flag: usu√°rio mexeu no zoom/pan
            const initialFitDoneRef = useRef(false); // Flag: j√° fez o primeiro fitBounds
            
            // Inicializa o mapa
            useEffect(() => {
                if (mapInstanceRef.current || !mapRef.current) return;
                
                const initialLat = currentPosition?.lat || restaurantLocation.lat;
                const initialLng = currentPosition?.lng || restaurantLocation.lng;
                
                mapInstanceRef.current = new google.maps.Map(mapRef.current, {
                    center: { lat: initialLat, lng: initialLng },
                    zoom: 15,
                    mapTypeControl: false,
                    streetViewControl: false,
                    fullscreenControl: false,
                });
                
                // Detecta quando o usu√°rio interage com o mapa (zoom/drag)
                google.maps.event.addListener(mapInstanceRef.current, 'dragstart', () => {
                    userInteractedRef.current = true;
                });
                google.maps.event.addListener(mapInstanceRef.current, 'zoom_changed', () => {
                    // S√≥ marca como intera√ß√£o se j√° fez o fit inicial
                    if (initialFitDoneRef.current) {
                        userInteractedRef.current = true;
                    }
                });
                
                return () => {
                    mapInstanceRef.current = null;
                };
            }, []);
            
            // Atualiza marcador de posi√ß√£o atual (sem mexer no zoom)
            useEffect(() => {
                if (!mapInstanceRef.current || !currentPosition) return;
                
                const pos = { lat: currentPosition.lat, lng: currentPosition.lng };
                
                if (positionMarkerRef.current) {
                    positionMarkerRef.current.setPosition(pos);
                } else {
                    positionMarkerRef.current = new google.maps.Marker({
                        position: pos,
                        map: mapInstanceRef.current,
                        icon: {
                            path: google.maps.SymbolPath.CIRCLE,
                            scale: 12,
                            fillColor: '#3b82f6',
                            fillOpacity: 1,
                            strokeColor: 'white',
                            strokeWeight: 3,
                        },
                        title: 'Voc√™ est√° aqui',
                        zIndex: 1000,
                    });
                }
            }, [currentPosition]);
            
            // Atualiza marcadores e rota
            useEffect(() => {
                if (!mapInstanceRef.current) return;
                
                // Remove marcadores antigos
                markersRef.current.forEach(marker => marker.setMap(null));
                markersRef.current = [];
                
                // Remove rota antiga
                if (routeLineRef.current) {
                    routeLineRef.current.setMap(null);
                    routeLineRef.current = null;
                }
                if (directionsRendererRef.current) {
                    directionsRendererRef.current.setMap(null);
                    directionsRendererRef.current = null;
                }
                
                // Marcador do restaurante
                const restaurantMarker = new google.maps.Marker({
                    position: { lat: restaurantLocation.lat, lng: restaurantLocation.lng },
                    map: mapInstanceRef.current,
                    icon: {
                        url: 'data:image/svg+xml,' + encodeURIComponent(`
                            <svg width="44" height="44" viewBox="0 0 44 44" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="22" cy="22" r="20" fill="#22c55e" stroke="white" stroke-width="3"/>
                                <text x="22" y="28" text-anchor="middle" font-size="20">üè™</text>
                            </svg>
                        `),
                        scaledSize: new google.maps.Size(44, 44),
                    },
                    title: 'Restaurante',
                });
                markersRef.current.push(restaurantMarker);
                
                // Coordenadas para rota
                const routeCoords = [];
                
                if (currentPosition) {
                    routeCoords.push({ lat: currentPosition.lat, lng: currentPosition.lng });
                } else {
                    routeCoords.push({ lat: restaurantLocation.lat, lng: restaurantLocation.lng });
                }
                
                // Pedidos pendentes
                const pendingOrders = orders.filter(o => o.status !== 'delivered');
                const deliveredOrders = orders.filter(o => o.status === 'delivered');
                
                // Marcadores entregues (cinza)
                deliveredOrders.forEach(order => {
                    const marker = new google.maps.Marker({
                        position: { lat: order.lat, lng: order.lng },
                        map: mapInstanceRef.current,
                        icon: {
                            url: 'data:image/svg+xml,' + encodeURIComponent(`
                                <svg width="36" height="36" viewBox="0 0 36 36" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="18" cy="18" r="16" fill="#9ca3af" stroke="white" stroke-width="3"/>
                                    <text x="18" y="24" text-anchor="middle" font-size="16" fill="white">‚úì</text>
                                </svg>
                            `),
                            scaledSize: new google.maps.Size(36, 36),
                        },
                        title: `Entregue - ${order.customer_name}`,
                    });
                    markersRef.current.push(marker);
                });
                
                // Marcadores pendentes (laranja)
                pendingOrders.forEach((order, index) => {
                    const isNext = index === 0;
                    const color = isNext ? '#f97316' : '#fb923c';
                    const size = isNext ? 44 : 36;
                    
                    const marker = new google.maps.Marker({
                        position: { lat: order.lat, lng: order.lng },
                        map: mapInstanceRef.current,
                        icon: {
                            url: 'data:image/svg+xml,' + encodeURIComponent(`
                                <svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}" xmlns="http://www.w3.org/2000/svg">
                                    <circle cx="${size/2}" cy="${size/2}" r="${size/2-3}" fill="${color}" stroke="white" stroke-width="3"/>
                                    <text x="${size/2}" y="${size/2+6}" text-anchor="middle" font-size="${isNext ? 18 : 14}" fill="white" font-weight="bold">${order.stop_order}</text>
                                </svg>
                            `),
                            scaledSize: new google.maps.Size(size, size),
                        },
                        title: `#${order.stop_order} - ${order.customer_name}`,
                    });
                    markersRef.current.push(marker);
                    routeCoords.push({ lat: order.lat, lng: order.lng });
                });
                
                // Se voltando ao restaurante
                if (returningHome) {
                    routeCoords.push({ lat: restaurantLocation.lat, lng: restaurantLocation.lng });
                }
                
                // Desenha rota REAL usando Google Directions API
                if (routeStarted && routeCoords.length > 1) {
                    const directionsService = new google.maps.DirectionsService();
                    directionsRendererRef.current = new google.maps.DirectionsRenderer({
                        map: mapInstanceRef.current,
                        suppressMarkers: true, // Usa os nossos marcadores customizados
                        polylineOptions: {
                            strokeColor: returningHome ? '#22c55e' : '#f97316',
                            strokeOpacity: 0.8,
                            strokeWeight: 5,
                        },
                    });
                    
                    // Monta origem, destino e waypoints
                    const origin = routeCoords[0];
                    const destination = routeCoords[routeCoords.length - 1];
                    const waypoints = routeCoords.slice(1, -1).map(coord => ({
                        location: coord,
                        stopover: true,
                    }));
                    
                    directionsService.route({
                        origin: origin,
                        destination: destination,
                        waypoints: waypoints,
                        optimizeWaypoints: false, // Mant√©m a ordem que definimos
                        travelMode: google.maps.TravelMode.DRIVING,
                    }, (result, status) => {
                        if (status === 'OK') {
                            directionsRendererRef.current.setDirections(result);
                            console.log('üõ£Ô∏è Rota real calculada!');
                            
                            // S√≥ faz fitBounds se for a primeira vez OU se usu√°rio n√£o interagiu
                            if (!initialFitDoneRef.current) {
                                const bounds = new google.maps.LatLngBounds();
                                routeCoords.forEach(coord => bounds.extend(coord));
                                mapInstanceRef.current.fitBounds(bounds, { padding: 60 });
                                
                                // Limita o zoom m√°ximo
                                const listener = google.maps.event.addListener(mapInstanceRef.current, 'idle', () => {
                                    if (mapInstanceRef.current.getZoom() > 15) {
                                        mapInstanceRef.current.setZoom(15);
                                    }
                                    google.maps.event.removeListener(listener);
                                    initialFitDoneRef.current = true;
                                });
                            }
                        } else {
                            console.error('‚ùå Erro ao calcular rota:', status);
                            // Fallback: linha reta se falhar
                            routeLineRef.current = new google.maps.Polyline({
                                path: routeCoords,
                                geodesic: true,
                                strokeColor: returningHome ? '#22c55e' : '#f97316',
                                strokeOpacity: 0.8,
                                strokeWeight: 5,
                            });
                            routeLineRef.current.setMap(mapInstanceRef.current);
                        }
                    });
                }
                
            }, [orders, restaurantLocation, routeStarted, returningHome, currentPosition]);
            
            const centerOnMe = () => {
                if (mapInstanceRef.current && currentPosition) {
                    mapInstanceRef.current.setCenter({ lat: currentPosition.lat, lng: currentPosition.lng });
                    mapInstanceRef.current.setZoom(16);
                }
            };
            
            const showFullRoute = () => {
                if (!mapInstanceRef.current) return;
                
                // Reseta a flag de intera√ß√£o
                userInteractedRef.current = false;
                
                const bounds = new google.maps.LatLngBounds();
                
                // Adiciona posi√ß√£o atual se dispon√≠vel
                if (currentPosition) {
                    bounds.extend({ lat: currentPosition.lat, lng: currentPosition.lng });
                }
                
                // Adiciona todos os pedidos
                orders.forEach(order => {
                    bounds.extend({ lat: order.lat, lng: order.lng });
                });
                
                // Adiciona restaurante
                bounds.extend({ lat: restaurantLocation.lat, lng: restaurantLocation.lng });
                
                mapInstanceRef.current.fitBounds(bounds, { padding: 60 });
                
                // Limita zoom m√°ximo
                setTimeout(() => {
                    if (mapInstanceRef.current.getZoom() > 15) {
                        mapInstanceRef.current.setZoom(15);
                    }
                }, 100);
            };
            
            return (
                <div className="relative">
                    <div ref={mapRef} style={{ width: '100%', height: '280px', borderRadius: '12px' }} />
                    
                    {/* Bot√µes do mapa */}
                    <div className="absolute bottom-3 right-3 z-10 flex flex-col gap-2">
                        <button 
                            onClick={centerOnMe}
                            className="bg-white p-3 rounded-xl shadow-lg text-blue-600 hover:bg-blue-50 active:scale-95 transition-all"
                            title="Minha localiza√ß√£o"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                <circle cx="12" cy="12" r="3"/>
                                <path d="M12 2v4m0 12v4m10-10h-4M6 12H2"/>
                            </svg>
                        </button>
                        <button 
                            onClick={showFullRoute}
                            className="bg-white p-3 rounded-xl shadow-lg text-orange-600 hover:bg-orange-50 active:scale-95 transition-all"
                            title="Ver toda a rota"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                <path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/>
                            </svg>
                        </button>
                    </div>
                </div>
            );
        };
        
        // ============ MODO NAVEGA√á√ÉO (TELA CHEIA - ESTILO WAZE) ============
        
        const NavigationMode = ({ 
            orders, 
            restaurantLocation, 
            currentPosition, 
            returningHome,
            onClose,
            onMarkDelivered,
            onOpenGoogleMaps,
            onOpenWaze
        }) => {
            const mapRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const directionsRendererRef = useRef(null);
            const positionMarkerRef = useRef(null);
            const destinationMarkerRef = useRef(null);
            const [followMode, setFollowMode] = useState(true); // Seguir usu√°rio automaticamente
            
            const pendingOrders = orders.filter(o => o.status !== 'delivered');
            const nextOrder = pendingOrders[0];
            const destination = returningHome 
                ? { lat: restaurantLocation.lat, lng: restaurantLocation.lng, name: 'Restaurante', address: restaurantLocation.address }
                : nextOrder 
                    ? { lat: nextOrder.lat, lng: nextOrder.lng, name: nextOrder.customer_name, address: nextOrder.address_text }
                    : null;
            
            // Inicializa mapa em modo navega√ß√£o
            useEffect(() => {
                if (!mapRef.current || mapInstanceRef.current) return;
                
                // Come√ßa centralizado na posi√ß√£o atual (como Waze)
                const center = currentPosition || { lat: restaurantLocation.lat, lng: restaurantLocation.lng };
                
                mapInstanceRef.current = new google.maps.Map(mapRef.current, {
                    center: center,
                    zoom: 17, // Zoom mais pr√≥ximo para navega√ß√£o
                    disableDefaultUI: true,
                    zoomControl: false,
                    mapTypeControl: false,
                    streetViewControl: false,
                    fullscreenControl: false,
                    gestureHandling: 'greedy',
                    styles: [
                        { featureType: 'poi', stylers: [{ visibility: 'off' }] },
                        { featureType: 'transit', stylers: [{ visibility: 'off' }] },
                    ]
                });
                
                // Quando usu√°rio arrasta o mapa, desativa follow mode
                google.maps.event.addListener(mapInstanceRef.current, 'dragstart', () => {
                    setFollowMode(false);
                });
            }, []);
            
            // Atualiza posi√ß√£o (SEGUE o usu√°rio se followMode ativo)
            useEffect(() => {
                if (!mapInstanceRef.current || !currentPosition) return;
                
                const pos = { lat: currentPosition.lat, lng: currentPosition.lng };
                
                // Atualiza marcador
                if (positionMarkerRef.current) {
                    positionMarkerRef.current.setPosition(pos);
                } else {
                    // Marcador maior e mais vis√≠vel para navega√ß√£o
                    positionMarkerRef.current = new google.maps.Marker({
                        position: pos,
                        map: mapInstanceRef.current,
                        icon: {
                            path: google.maps.SymbolPath.FORWARD_CLOSED_ARROW,
                            scale: 8,
                            fillColor: '#3b82f6',
                            fillOpacity: 1,
                            strokeColor: 'white',
                            strokeWeight: 3,
                            rotation: 0,
                        },
                        title: 'Voc√™',
                        zIndex: 1000,
                    });
                }
                
                // Se followMode ativo, centraliza no usu√°rio
                if (followMode) {
                    mapInstanceRef.current.panTo(pos);
                }
            }, [currentPosition, followMode]);
            
            // Desenha rota e destino
            useEffect(() => {
                if (!mapInstanceRef.current || !destination) return;
                
                // Marcador do destino
                const destColor = returningHome ? '#22c55e' : '#f97316';
                const destIcon = returningHome ? 'üè™' : (nextOrder?.stop_order || '1');
                
                if (destinationMarkerRef.current) {
                    destinationMarkerRef.current.setMap(null);
                }
                
                destinationMarkerRef.current = new google.maps.Marker({
                    position: { lat: destination.lat, lng: destination.lng },
                    map: mapInstanceRef.current,
                    icon: {
                        url: 'data:image/svg+xml,' + encodeURIComponent(`
                            <svg width="56" height="56" viewBox="0 0 56 56" xmlns="http://www.w3.org/2000/svg">
                                <circle cx="28" cy="28" r="24" fill="${destColor}" stroke="white" stroke-width="4"/>
                                <text x="28" y="36" text-anchor="middle" font-size="${returningHome ? 24 : 20}" fill="white" font-weight="bold">${returningHome ? 'üè™' : destIcon}</text>
                            </svg>
                        `),
                        scaledSize: new google.maps.Size(56, 56),
                    },
                    title: destination.name,
                });
                
                // Desenha rota
                if (currentPosition) {
                    if (directionsRendererRef.current) {
                        directionsRendererRef.current.setMap(null);
                    }
                    
                    const directionsService = new google.maps.DirectionsService();
                    directionsRendererRef.current = new google.maps.DirectionsRenderer({
                        map: mapInstanceRef.current,
                        suppressMarkers: true,
                        polylineOptions: {
                            strokeColor: destColor,
                            strokeOpacity: 0.9,
                            strokeWeight: 7,
                        },
                    });
                    
                    directionsService.route({
                        origin: { lat: currentPosition.lat, lng: currentPosition.lng },
                        destination: { lat: destination.lat, lng: destination.lng },
                        travelMode: google.maps.TravelMode.DRIVING,
                    }, (result, status) => {
                        if (status === 'OK') {
                            directionsRendererRef.current.setDirections(result);
                        }
                    });
                }
            }, [destination, currentPosition, returningHome]);
            
            // Calcula dist√¢ncia
            const getDistance = () => {
                if (!currentPosition || !destination) return null;
                const R = 6371000;
                const dLat = (destination.lat - currentPosition.lat) * Math.PI / 180;
                const dLng = (destination.lng - currentPosition.lng) * Math.PI / 180;
                const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                          Math.cos(currentPosition.lat * Math.PI / 180) * Math.cos(destination.lat * Math.PI / 180) *
                          Math.sin(dLng/2) * Math.sin(dLng/2);
                const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
                return R * c;
            };
            
            const distance = getDistance();
            
            const reactivateFollow = () => {
                setFollowMode(true);
                if (mapInstanceRef.current && currentPosition) {
                    mapInstanceRef.current.panTo({ lat: currentPosition.lat, lng: currentPosition.lng });
                    mapInstanceRef.current.setZoom(17);
                }
            };
            
            return (
                <div className="fixed inset-0 z-50 bg-gray-900 flex flex-col">
                    {/* Header navega√ß√£o */}
                    <div className="bg-white p-4 shadow-lg">
                        <div className="flex items-center justify-between">
                            <button 
                                onClick={onClose}
                                className="p-2 hover:bg-gray-100 rounded-xl"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                    <path d="M19 12H5M12 19l-7-7 7-7"/>
                                </svg>
                            </button>
                            <div className="text-center flex-1 mx-4">
                                <div className="font-bold text-gray-800 truncate">{destination?.name || 'Carregando...'}</div>
                                <div className="text-sm text-gray-500 truncate">{destination?.address || ''}</div>
                            </div>
                            {distance && (
                                <div className="text-right">
                                    <div className="font-bold text-orange-600 text-lg">
                                        {distance < 1000 ? `${Math.round(distance)}m` : `${(distance/1000).toFixed(1)}km`}
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                    
                    {/* Mapa em tela cheia */}
                    <div ref={mapRef} className="flex-1" />
                    
                    {/* Bot√£o recentralizar (aparece quando usu√°rio mexeu no mapa) */}
                    {!followMode && (
                        <button 
                            onClick={reactivateFollow}
                            className="absolute right-4 bottom-52 bg-blue-500 p-4 rounded-full shadow-lg text-white hover:bg-blue-600 active:scale-95 z-10 animate-pulse"
                        >
                            <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2.5">
                                <circle cx="12" cy="12" r="3"/>
                                <path d="M12 2v4m0 12v4m10-10h-4M6 12H2"/>
                            </svg>
                        </button>
                    )}
                    
                    {/* Footer com a√ß√µes */}
                    <div className="bg-white p-4 shadow-lg safe-area-bottom">
                        <div className="flex gap-3 mb-3">
                            <button 
                                onClick={() => onOpenGoogleMaps(destination.lat, destination.lng)}
                                className="flex-1 bg-blue-500 text-white py-3 rounded-xl font-semibold flex items-center justify-center gap-2 active:scale-95"
                            >
                                üó∫Ô∏è Google Maps
                            </button>
                            <button 
                                onClick={() => onOpenWaze(destination.lat, destination.lng)}
                                className="flex-1 bg-purple-500 text-white py-3 rounded-xl font-semibold flex items-center justify-center gap-2 active:scale-95"
                            >
                                üöó Waze
                            </button>
                        </div>
                        
                        {!returningHome && nextOrder && (
                            <button 
                                onClick={() => onMarkDelivered(nextOrder.id)}
                                className="w-full bg-green-500 text-white py-4 rounded-xl font-bold text-lg flex items-center justify-center gap-2 active:scale-95"
                            >
                                ‚úì Entreguei para {nextOrder.customer_name}
                            </button>
                        )}
                        
                        {returningHome && (
                            <button 
                                onClick={onClose}
                                className="w-full bg-green-500 text-white py-4 rounded-xl font-bold text-lg flex items-center justify-center gap-2 active:scale-95"
                            >
                                ‚úÖ Cheguei no Restaurante
                            </button>
                        )}
                    </div>
                </div>
            );
        };
        
        // ============ TELA PRINCIPAL DO MOTOBOY ============
        
        const MainScreen = ({ courier, onLogout }) => {
            const [batch, setBatch] = useState(null);
            const [loading, setLoading] = useState(true);
            const [refreshing, setRefreshing] = useState(false);
            const [routeStarted, setRouteStarted] = useState(false);
            const [currentPosition, setCurrentPosition] = useState(null);
            const [gpsError, setGpsError] = useState(null);
            const [returningHome, setReturningHome] = useState(false);
            const [navigationMode, setNavigationMode] = useState(false);
            const watchIdRef = useRef(null);
            
            const fetchBatch = useCallback(async () => {
                try {
                    const res = await fetch(`${API_URL}/couriers/${courier.id}/current-batch`);
                    if (res.ok) {
                        const data = await res.json();
                        setBatch(data);
                        
                        if (data.orders && data.orders.length > 0) {
                            const allDelivered = data.orders.every(o => o.status === 'delivered');
                            if (allDelivered && routeStarted && !returningHome) {
                                setReturningHome(true);
                            }
                        }
                    } else {
                        setBatch(null);
                        setRouteStarted(false);
                        setReturningHome(false);
                    }
                } catch (err) {
                    console.error('Erro ao buscar lote:', err);
                }
                setLoading(false);
                setRefreshing(false);
            }, [courier.id, routeStarted, returningHome]);
            
            useEffect(() => {
                fetchBatch();
                const interval = setInterval(fetchBatch, 5000);
                return () => clearInterval(interval);
            }, [fetchBatch]);
            
            const startGPSTracking = () => {
                if (!navigator.geolocation) {
                    setGpsError('GPS n√£o dispon√≠vel');
                    return;
                }
                
                watchIdRef.current = navigator.geolocation.watchPosition(
                    (position) => {
                        setCurrentPosition({
                            lat: position.coords.latitude,
                            lng: position.coords.longitude,
                        });
                        setGpsError(null);
                    },
                    (error) => setGpsError('Erro ao obter localiza√ß√£o'),
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            };
            
            const stopGPSTracking = () => {
                if (watchIdRef.current) {
                    navigator.geolocation.clearWatch(watchIdRef.current);
                }
            };
            
            useEffect(() => () => stopGPSTracking(), []);
            
            const handleStartRoute = () => {
                setRouteStarted(true);
                startGPSTracking();
            };
            
            const openGoogleMaps = (lat, lng) => {
                window.open(`https://www.google.com/maps/dir/?api=1&destination=${lat},${lng}&travelmode=driving`, '_blank');
            };
            
            const openWaze = (lat, lng) => {
                window.open(`https://waze.com/ul?ll=${lat},${lng}&navigate=yes`, '_blank');
            };
            
            const markDelivered = async (orderId) => {
                await fetch(`${API_URL}/orders/${orderId}/pickup`, { method: 'POST' });
                await fetch(`${API_URL}/orders/${orderId}/deliver`, { method: 'POST' });
                fetchBatch();
            };
            
            const finishBatch = async () => {
                if (!confirm('Confirma que chegou no restaurante?')) return;
                await fetch(`${API_URL}/couriers/${courier.id}/complete-batch`, { method: 'POST' });
                stopGPSTracking();
                setRouteStarted(false);
                setReturningHome(false);
                fetchBatch();
            };
            
            const getDistanceToOrder = (order) => {
                if (!currentPosition) return null;
                return calculateDistance(currentPosition.lat, currentPosition.lng, order.lat, order.lng);
            };
            
            const getDistanceToRestaurant = () => {
                if (!currentPosition) return null;
                return calculateDistance(currentPosition.lat, currentPosition.lng, RESTAURANT_LOCATION.lat, RESTAURANT_LOCATION.lng);
            };
            
            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-gray-100">
                        <div className="text-center">
                            <Logo size={60} />
                            <div className="text-gray-500 mt-4">Carregando entregas...</div>
                        </div>
                    </div>
                );
            }
            
            // Sem entregas
            if (!batch || !batch.orders || batch.orders.length === 0) {
                return (
                    <div className="min-h-screen bg-gray-100">
                        <header className="bg-white shadow-sm p-4">
                            <div className="flex items-center justify-between">
                                <div className="flex items-center gap-3">
                                    <Logo size={40} />
                                    <div>
                                        <div className="font-semibold text-gray-800">{courier.name}</div>
                                        <div className="text-xs text-green-600">üü¢ Dispon√≠vel</div>
                                    </div>
                                </div>
                                <Button onClick={onLogout} variant="secondary" size="small">Sair</Button>
                            </div>
                        </header>
                        
                        <div className="flex flex-col items-center justify-center p-6" style={{ minHeight: 'calc(100vh - 80px)' }}>
                            <div className="text-6xl mb-4">‚òï</div>
                            <h2 className="text-xl font-semibold text-gray-700 mb-2">Nenhuma entrega no momento</h2>
                            <p className="text-gray-500 mb-6">Aguarde o restaurante enviar pedidos</p>
                            <Button onClick={() => { setRefreshing(true); fetchBatch(); }} disabled={refreshing}>
                                {refreshing ? '‚è≥ Atualizando...' : 'üîÑ Atualizar'}
                            </Button>
                        </div>
                    </div>
                );
            }
            
            const pendingOrders = batch.orders.filter(o => o.status !== 'delivered');
            const deliveredOrders = batch.orders.filter(o => o.status === 'delivered');
            const allDelivered = pendingOrders.length === 0;
            
            // Modo navega√ß√£o em tela cheia
            if (navigationMode) {
                return (
                    <NavigationMode
                        orders={batch.orders}
                        restaurantLocation={RESTAURANT_LOCATION}
                        currentPosition={currentPosition}
                        returningHome={returningHome}
                        onClose={() => setNavigationMode(false)}
                        onMarkDelivered={(orderId) => {
                            markDelivered(orderId);
                            // Se era a √∫ltima entrega, fecha navega√ß√£o
                            if (pendingOrders.length <= 1) {
                                setNavigationMode(false);
                            }
                        }}
                        onOpenGoogleMaps={openGoogleMaps}
                        onOpenWaze={openWaze}
                    />
                );
            }
            
            return (
                <div className="min-h-screen bg-gray-100 pb-32">
                    {/* Header */}
                    <header className="bg-white shadow-sm p-4 sticky top-0 z-50">
                        <div className="flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <Logo size={40} />
                                <div>
                                    <div className="font-semibold text-gray-800">{courier.name}</div>
                                    <div className="text-xs text-orange-600">
                                        {returningHome ? 'üè† Voltando ao restaurante' : `üü† ${pendingOrders.length} entrega(s)`}
                                    </div>
                                </div>
                            </div>
                            <div className="flex items-center gap-2">
                                {currentPosition && (
                                    <span className="text-xs text-green-600 bg-green-50 px-2 py-1 rounded-full">üìç GPS OK</span>
                                )}
                                <Button onClick={onLogout} variant="secondary" size="small">Sair</Button>
                            </div>
                        </div>
                    </header>
                    
                    {gpsError && (
                        <div className="mx-4 mt-4 p-3 bg-red-100 text-red-700 rounded-xl text-sm">‚ö†Ô∏è {gpsError}</div>
                    )}
                    
                    {/* Bot√£o Iniciar Rota */}
                    {!routeStarted && (
                        <div className="p-4">
                            <Button onClick={handleStartRoute} variant="success" size="large" className="w-full pulse-green">
                                üöÄ Iniciar Rota ({batch.orders.length} entregas)
                            </Button>
                        </div>
                    )}
                    
                    {/* Mapa Google */}
                    {routeStarted && (
                        <div className="p-4">
                            <Card className="overflow-hidden p-0">
                                <DeliveryMap 
                                    orders={batch.orders} 
                                    restaurantLocation={RESTAURANT_LOCATION}
                                    currentPosition={currentPosition}
                                    routeStarted={routeStarted}
                                    returningHome={returningHome}
                                />
                            </Card>
                            
                            {/* Bot√£o Modo Navega√ß√£o */}
                            <button 
                                onClick={() => setNavigationMode(true)}
                                className="w-full mt-3 bg-gradient-to-r from-blue-500 to-blue-600 text-white py-4 rounded-xl font-bold text-lg flex items-center justify-center gap-2 active:scale-95 shadow-lg"
                            >
                                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                    <polygon points="3 11 22 2 13 21 11 13 3 11"/>
                                </svg>
                                Iniciar Navega√ß√£o
                            </button>
                        </div>
                    )}
                    
                    {/* Voltando ao restaurante */}
                    {returningHome && (
                        <div className="px-4 mb-4">
                            <Card className="p-4 border-2 border-green-500 bg-green-50">
                                <div className="flex items-center gap-3">
                                    <div className="text-4xl">üè™</div>
                                    <div className="flex-1">
                                        <h3 className="font-bold text-green-700">Voltar ao Restaurante</h3>
                                        <p className="text-sm text-green-600">{RESTAURANT_LOCATION.address}</p>
                                        {currentPosition && (
                                            <p className="text-xs text-green-500 mt-1">üìç {Math.round(getDistanceToRestaurant())}m</p>
                                        )}
                                    </div>
                                </div>
                                <div className="flex gap-2 mt-3">
                                    <Button onClick={() => openGoogleMaps(RESTAURANT_LOCATION.lat, RESTAURANT_LOCATION.lng)} variant="navigation" size="small">
                                        üó∫Ô∏è Google Maps
                                    </Button>
                                    <Button onClick={() => openWaze(RESTAURANT_LOCATION.lat, RESTAURANT_LOCATION.lng)} variant="secondary" size="small">
                                        üöó Waze
                                    </Button>
                                </div>
                            </Card>
                        </div>
                    )}
                    
                    {/* Lista de entregas */}
                    {!returningHome && routeStarted && (
                        <div className="px-4">
                            <h3 className="font-semibold text-gray-700 mb-3">
                                üìç Suas entregas ({deliveredOrders.length}/{batch.orders.length})
                            </h3>
                            
                            <div className="space-y-3">
                                {batch.orders.map((order) => {
                                    const isDelivered = order.status === 'delivered';
                                    const isNext = !isDelivered && pendingOrders[0]?.id === order.id;
                                    const distance = getDistanceToOrder(order);
                                    
                                    return (
                                        <Card key={order.id} className={`p-4 ${isDelivered ? 'opacity-60' : isNext ? 'border-2 border-orange-500 bg-orange-50' : ''}`}>
                                            <div className="flex items-start gap-3">
                                                <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold text-white ${isDelivered ? 'bg-gray-400' : 'bg-orange-500'}`}>
                                                    {isDelivered ? '‚úì' : order.stop_order}
                                                </div>
                                                <div className="flex-1">
                                                    <div className="flex items-center gap-2 flex-wrap">
                                                        <span className="font-semibold text-gray-800">{order.customer_name}</span>
                                                        {isDelivered && <span className="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded-full">‚úì Entregue</span>}
                                                        {isNext && <span className="text-xs bg-orange-100 text-orange-700 px-2 py-0.5 rounded-full">Pr√≥xima</span>}
                                                    </div>
                                                    <p className="text-sm text-gray-500 mt-1">{order.address_text}</p>
                                                    
                                                    {isNext && distance && (
                                                        <p className="text-xs text-gray-500 mt-1">üìç {distance < 1000 ? `${Math.round(distance)}m` : `${(distance/1000).toFixed(1)}km`}</p>
                                                    )}
                                                    
                                                    {isNext && (
                                                        <div className="flex flex-wrap gap-2 mt-3">
                                                            <Button onClick={() => openGoogleMaps(order.lat, order.lng)} variant="navigation" size="small">üó∫Ô∏è Maps</Button>
                                                            <Button onClick={() => openWaze(order.lat, order.lng)} variant="secondary" size="small">üöó Waze</Button>
                                                            <Button onClick={() => markDelivered(order.id)} variant="success" size="small">‚úì Entreguei</Button>
                                                        </div>
                                                    )}
                                                </div>
                                            </div>
                                        </Card>
                                    );
                                })}
                            </div>
                        </div>
                    )}
                    
                    {/* Footer */}
                    <div className="fixed bottom-0 left-0 right-0 p-4 bg-white border-t shadow-lg">
                        {returningHome ? (
                            <Button onClick={finishBatch} variant="success" size="large" className="w-full">
                                ‚úÖ Cheguei no restaurante!
                            </Button>
                        ) : (
                            <div className="text-center text-gray-500 text-sm">
                                {allDelivered ? 'Calculando rota de volta...' : routeStarted ? `Entregue os ${pendingOrders.length} pedido(s)` : 'Clique em "Iniciar Rota"'}
                            </div>
                        )}
                    </div>
                </div>
            );
        };
        
        // ============ APP PRINCIPAL ============
        
        const App = () => {
            const [courier, setCourier] = useState(null);
            const [loading, setLoading] = useState(true);
            
            useEffect(() => {
                const savedId = localStorage.getItem('motoboy_id');
                const savedName = localStorage.getItem('motoboy_name');
                
                if (savedId && savedName) {
                    fetch(`${API_URL}/couriers`)
                        .then(res => res.json())
                        .then(couriers => {
                            const found = couriers.find(c => c.id === savedId);
                            if (found) setCourier(found);
                            else {
                                localStorage.removeItem('motoboy_id');
                                localStorage.removeItem('motoboy_name');
                            }
                            setLoading(false);
                        })
                        .catch(() => setLoading(false));
                } else {
                    setLoading(false);
                }
            }, []);
            
            if (loading) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-orange-500">
                        <div className="text-center text-white">
                            <div className="mb-4 flex justify-center"><LogoLight size={80} /></div>
                            <div className="text-xl font-semibold">MotoFlash</div>
                        </div>
                    </div>
                );
            }
            
            if (!courier) return <LoginScreen onLogin={setCourier} />;
            return <MainScreen courier={courier} onLogout={() => { localStorage.clear(); setCourier(null); }} />;
        };
        
        // ============ RENDER com Geocoding ============
        (async function init() {
            const root = ReactDOM.createRoot(document.getElementById('root'));
            
            root.render(
                <div className="min-h-screen flex items-center justify-center bg-gradient-to-b from-orange-500 to-orange-600">
                    <div className="text-center text-white">
                        <div className="mb-4 flex justify-center"><LogoLight size={80} /></div>
                        <div className="text-xl font-semibold mb-2">MotoFlash</div>
                        <div className="text-orange-100">Carregando localiza√ß√£o...</div>
                    </div>
                </div>
            );
            
            const success = await loadRestaurantLocation();
            
            if (!success) {
                root.render(
                    <div className="min-h-screen flex items-center justify-center bg-gray-100 p-6">
                        <div className="text-center">
                            <div className="text-5xl mb-4">‚ö†Ô∏è</div>
                            <h2 className="text-xl font-semibold text-red-600 mb-2">Erro ao carregar</h2>
                            <p className="text-gray-600 mb-4">Verifique se o backend est√° rodando</p>
                            <button onClick={() => location.reload()} className="bg-orange-500 text-white px-6 py-3 rounded-xl font-semibold">
                                üîÑ Tentar Novamente
                            </button>
                        </div>
                    </div>
                );
                return;
            }
            
            root.render(<App />);
        })();
    </script>
</body>
</html>
